# Linux Cgroup èµ„æºæ§åˆ¶

> ğŸ“– å‚è€ƒä¹¦ç±ï¼šã€Šæ·±å…¥ç†è§£ Linux è¿›ç¨‹ä¸å†…å­˜ã€‹
>
> ğŸ¤– ç¬”è®°æ–¹å¼ï¼šé˜…è¯»ä¹¦ç± + AI è¾…åŠ©ç­”ç–‘æ•´ç†
>
> æœ¬æ–‡æ·±å…¥è®²è§£ Cgroup çš„åŸç†å’Œä½¿ç”¨ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ç­‰èµ„æºçš„é™åˆ¶æœºåˆ¶ã€‚

## ç›®å½•

1. [Cgroup æ§åˆ¶ç»„çš„åˆ›å»º](#1-cgroup-æ§åˆ¶ç»„çš„åˆ›å»º)
2. [Cgroup å†…æ ¸æ•°æ®ç»“æ„](#2-cgroup-å†…æ ¸æ•°æ®ç»“æ„)
3. [CPU èµ„æºé™åˆ¶](#3-cpu-èµ„æºé™åˆ¶)

---

## 1. Cgroup æ§åˆ¶ç»„çš„åˆ›å»º

Cgroup çš„ä¸€ä¸ªç¥å¥‡ä¹‹å¤„ï¼š**é€šè¿‡ mkdir åˆ›å»ºç›®å½•å°±èƒ½åˆ›å»ºæ§åˆ¶ç»„**ï¼Œå†…æ ¸ä¼šè‡ªåŠ¨ç”Ÿæˆæ§åˆ¶æ–‡ä»¶ã€‚

### 1.1 Cgroup v1 çš„åˆ›å»ºæ–¹å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cgroup v1 åˆ›å»ºæ§åˆ¶ç»„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   v1 ä¸­æ¯ä¸ªå­ç³»ç»Ÿæœ‰ç‹¬ç«‹çš„æŒ‚è½½ç‚¹ï¼Œéœ€è¦åˆ†åˆ«åˆ›å»ºï¼š                 â”‚
â”‚                                                                 â”‚
â”‚   # åœ¨ cpu å­ç³»ç»Ÿä¸‹åˆ›å»ºæ§åˆ¶ç»„                                   â”‚
â”‚   mkdir /sys/fs/cgroup/cpu/mygroup                              â”‚
â”‚                                                                 â”‚
â”‚   # å†…æ ¸è‡ªåŠ¨ç”Ÿæˆæ§åˆ¶æ–‡ä»¶ï¼š                                      â”‚
â”‚   /sys/fs/cgroup/cpu/mygroup/                                   â”‚
â”‚   â”œâ”€â”€ cpu.cfs_period_us      # CFS è°ƒåº¦å‘¨æœŸï¼ˆå¾®ç§’ï¼‰             â”‚
â”‚   â”œâ”€â”€ cpu.cfs_quota_us       # CFS é…é¢ï¼ˆå¾®ç§’ï¼‰                 â”‚
â”‚   â”œâ”€â”€ cpu.shares             # CPU ä»½é¢ï¼ˆç›¸å¯¹æƒé‡ï¼‰             â”‚
â”‚   â”œâ”€â”€ cpu.stat               # CPU ç»Ÿè®¡ä¿¡æ¯                     â”‚
â”‚   â”œâ”€â”€ tasks                  # å±äºè¯¥ç»„çš„çº¿ç¨‹ TID               â”‚
â”‚   â”œâ”€â”€ cgroup.procs           # å±äºè¯¥ç»„çš„è¿›ç¨‹ PID               â”‚
â”‚   â””â”€â”€ ...                                                       â”‚
â”‚                                                                 â”‚
â”‚   # å¦‚æœè¿˜è¦é™åˆ¶å†…å­˜ï¼Œéœ€è¦åœ¨ memory å­ç³»ç»Ÿå†åˆ›å»ºä¸€æ¬¡            â”‚
â”‚   mkdir /sys/fs/cgroup/memory/mygroup                           â”‚
â”‚                                                                 â”‚
â”‚   /sys/fs/cgroup/memory/mygroup/                                â”‚
â”‚   â”œâ”€â”€ memory.limit_in_bytes  # å†…å­˜é™åˆ¶                         â”‚
â”‚   â”œâ”€â”€ memory.usage_in_bytes  # å½“å‰ä½¿ç”¨é‡                       â”‚
â”‚   â”œâ”€â”€ tasks                                                     â”‚
â”‚   â””â”€â”€ ...                                                       â”‚
â”‚                                                                 â”‚
â”‚   é—®é¢˜ï¼šåŒä¸€ä¸ª"mygroup"åœ¨ä¸åŒå­ç³»ç»Ÿæ˜¯ç‹¬ç«‹çš„ï¼                   â”‚
â”‚         éœ€è¦åˆ†åˆ«ç®¡ç†ï¼Œå®¹æ˜“ä¸ä¸€è‡´                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```bash
# Cgroup v1 å®é™…æ“ä½œç¤ºä¾‹

# 1. åˆ›å»º CPU æ§åˆ¶ç»„
mkdir /sys/fs/cgroup/cpu/mycontainer

# 2. æŸ¥çœ‹è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶
ls /sys/fs/cgroup/cpu/mycontainer/
# cpu.cfs_period_us  cpu.cfs_quota_us  cpu.shares  cpu.stat  tasks  ...

# 3. è®¾ç½® CPU é™åˆ¶ï¼ˆé™åˆ¶ä¸º 0.5 æ ¸ï¼‰
echo 50000 > /sys/fs/cgroup/cpu/mycontainer/cpu.cfs_quota_us
echo 100000 > /sys/fs/cgroup/cpu/mycontainer/cpu.cfs_period_us

# 4. å°†è¿›ç¨‹åŠ å…¥æ§åˆ¶ç»„
echo $PID > /sys/fs/cgroup/cpu/mycontainer/tasks

# 5. åˆ é™¤æ§åˆ¶ç»„ï¼ˆå¿…é¡»å…ˆç§»é™¤æ‰€æœ‰è¿›ç¨‹ï¼‰
rmdir /sys/fs/cgroup/cpu/mycontainer
```

### 1.2 Cgroup v2 çš„åˆ›å»ºæ–¹å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cgroup v2 åˆ›å»ºæ§åˆ¶ç»„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   v2 æ˜¯ç»Ÿä¸€å±‚çº§ï¼Œä¸€æ¬¡ mkdir å°±èƒ½ç®¡ç†æ‰€æœ‰èµ„æºï¼š                  â”‚
â”‚                                                                 â”‚
â”‚   # åˆ›å»ºæ§åˆ¶ç»„                                                  â”‚
â”‚   mkdir /sys/fs/cgroup/mygroup                                  â”‚
â”‚                                                                 â”‚
â”‚   # å†…æ ¸è‡ªåŠ¨ç”Ÿæˆç»Ÿä¸€çš„æ§åˆ¶æ–‡ä»¶ï¼š                                â”‚
â”‚   /sys/fs/cgroup/mygroup/                                       â”‚
â”‚   â”œâ”€â”€ cgroup.controllers     # å¯ç”¨çš„æ§åˆ¶å™¨åˆ—è¡¨                 â”‚
â”‚   â”œâ”€â”€ cgroup.subtree_control # å­æ ‘å¯ç”¨çš„æ§åˆ¶å™¨                 â”‚
â”‚   â”œâ”€â”€ cgroup.procs           # è¿›ç¨‹åˆ—è¡¨                         â”‚
â”‚   â”œâ”€â”€ cgroup.threads         # çº¿ç¨‹åˆ—è¡¨                         â”‚
â”‚   â”‚                                                             â”‚
â”‚   â”‚   # CPU ç›¸å…³ï¼ˆå¦‚æœå¯ç”¨äº† cpu æ§åˆ¶å™¨ï¼‰                       â”‚
â”‚   â”œâ”€â”€ cpu.max                # CPU é…é¢ "quota period"          â”‚
â”‚   â”œâ”€â”€ cpu.weight             # CPU æƒé‡ï¼ˆæ›¿ä»£ sharesï¼‰          â”‚
â”‚   â”œâ”€â”€ cpu.stat               # CPU ç»Ÿè®¡                         â”‚
â”‚   â”‚                                                             â”‚
â”‚   â”‚   # å†…å­˜ç›¸å…³ï¼ˆå¦‚æœå¯ç”¨äº† memory æ§åˆ¶å™¨ï¼‰                    â”‚
â”‚   â”œâ”€â”€ memory.max             # å†…å­˜ç¡¬é™åˆ¶                       â”‚
â”‚   â”œâ”€â”€ memory.high            # å†…å­˜è½¯é™åˆ¶                       â”‚
â”‚   â”œâ”€â”€ memory.current         # å½“å‰ä½¿ç”¨é‡                       â”‚
â”‚   â”‚                                                             â”‚
â”‚   â”‚   # IO ç›¸å…³ï¼ˆå¦‚æœå¯ç”¨äº† io æ§åˆ¶å™¨ï¼‰                         â”‚
â”‚   â”œâ”€â”€ io.max                 # IO é™åˆ¶                          â”‚
â”‚   â””â”€â”€ ...                                                       â”‚
â”‚                                                                 â”‚
â”‚   ä¼˜åŠ¿ï¼šä¸€ä¸ªç›®å½•ç®¡ç†æ‰€æœ‰èµ„æºï¼Œä¸ä¼šå‡ºç°ä¸ä¸€è‡´                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


```bash
# Cgroup v2 å®é™…æ“ä½œç¤ºä¾‹

# 1. æŸ¥çœ‹æ ¹ç›®å½•å¯ç”¨çš„æ§åˆ¶å™¨
cat /sys/fs/cgroup/cgroup.controllers
# cpuset cpu io memory hugetlb pids rdma misc

# 2. å¯ç”¨å­æ ‘çš„æ§åˆ¶å™¨ï¼ˆå¿…é¡»å…ˆå¯ç”¨æ‰èƒ½åœ¨å­ç›®å½•ä½¿ç”¨ï¼‰
echo "+cpu +memory" > /sys/fs/cgroup/cgroup.subtree_control

# 3. åˆ›å»ºæ§åˆ¶ç»„
mkdir /sys/fs/cgroup/mycontainer

# 4. æŸ¥çœ‹è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶
ls /sys/fs/cgroup/mycontainer/
# cgroup.controllers  cgroup.procs  cpu.max  cpu.stat  memory.max  ...

# 5. è®¾ç½® CPU é™åˆ¶ï¼ˆé™åˆ¶ä¸º 0.5 æ ¸ï¼‰
# æ ¼å¼ï¼š"quota period"ï¼Œå•ä½å¾®ç§’
echo "50000 100000" > /sys/fs/cgroup/mycontainer/cpu.max

# 6. è®¾ç½®å†…å­˜é™åˆ¶ï¼ˆ1GBï¼‰
echo 1073741824 > /sys/fs/cgroup/mycontainer/memory.max

# 7. å°†è¿›ç¨‹åŠ å…¥æ§åˆ¶ç»„
echo $PID > /sys/fs/cgroup/mycontainer/cgroup.procs

# 8. åˆ é™¤æ§åˆ¶ç»„
rmdir /sys/fs/cgroup/mycontainer
```

### 1.3 v1 vs v2 åˆ›å»ºæ–¹å¼å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åˆ›å»ºæ–¹å¼å¯¹æ¯”                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   æ“ä½œ              â”‚ Cgroup v1              â”‚ Cgroup v2        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   åˆ›å»ºæ§åˆ¶ç»„        â”‚ æ¯ä¸ªå­ç³»ç»Ÿåˆ†åˆ« mkdir   â”‚ ä¸€æ¬¡ mkdir       â”‚
â”‚                     â”‚ mkdir cpu/mygroup      â”‚ mkdir mygroup    â”‚
â”‚                     â”‚ mkdir memory/mygroup   â”‚                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   å¯ç”¨æ§åˆ¶å™¨        â”‚ ä¸éœ€è¦ï¼ˆæŒ‚è½½æ—¶å†³å®šï¼‰   â”‚ éœ€è¦æ˜¾å¼å¯ç”¨     â”‚
â”‚                     â”‚                        â”‚ subtree_control  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   CPU é…é¢æ–‡ä»¶      â”‚ cpu.cfs_quota_us       â”‚ cpu.max          â”‚
â”‚                     â”‚ cpu.cfs_period_us      â”‚ (åˆå¹¶ä¸ºä¸€ä¸ª)     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   CPU æƒé‡æ–‡ä»¶      â”‚ cpu.shares             â”‚ cpu.weight       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   è¿›ç¨‹åˆ—è¡¨æ–‡ä»¶      â”‚ tasks / cgroup.procs   â”‚ cgroup.procs     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   åˆ é™¤æ§åˆ¶ç»„        â”‚ rmdirï¼ˆæ¯ä¸ªå­ç³»ç»Ÿï¼‰    â”‚ rmdirï¼ˆä¸€æ¬¡ï¼‰    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 ä¸ºä»€ä¹ˆ mkdir å°±èƒ½åˆ›å»ºæ§åˆ¶æ–‡ä»¶ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cgroup æ–‡ä»¶ç³»ç»Ÿçš„é­”æ³•                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Cgroup ä½¿ç”¨çš„æ˜¯å†…æ ¸è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆç±»ä¼¼ /procã€/sysï¼‰           â”‚
â”‚                                                                 â”‚
â”‚   1. æŒ‚è½½ Cgroup æ–‡ä»¶ç³»ç»Ÿ                                       â”‚
â”‚      mount -t cgroup2 none /sys/fs/cgroup                       â”‚
â”‚                                                                 â”‚
â”‚   2. å†…æ ¸æ³¨å†Œäº†ç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œ                               â”‚
â”‚      â””â”€â”€ mkdir æ“ä½œè¢«å†…æ ¸æ‹¦æˆª                                   â”‚
â”‚          ä¸æ˜¯çœŸçš„åœ¨ç£ç›˜åˆ›å»ºç›®å½•                                 â”‚
â”‚          è€Œæ˜¯åœ¨å†…æ ¸ä¸­åˆ›å»º cgroup æ•°æ®ç»“æ„                       â”‚
â”‚                                                                 â”‚
â”‚   3. å†…æ ¸è‡ªåŠ¨å¡«å……æ§åˆ¶æ–‡ä»¶                                       â”‚
â”‚      â””â”€â”€ æ ¹æ®å¯ç”¨çš„æ§åˆ¶å™¨                                       â”‚
â”‚          è‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„æ¥å£æ–‡ä»¶                                 â”‚
â”‚                                                                 â”‚
â”‚   4. è¯»å†™æ–‡ä»¶ = è¯»å†™å†…æ ¸æ•°æ®ç»“æ„                                â”‚
â”‚      â””â”€â”€ echo "50000 100000" > cpu.max                          â”‚
â”‚          å®é™…æ˜¯è°ƒç”¨å†…æ ¸å‡½æ•°è®¾ç½® CPU é…é¢                        â”‚
â”‚                                                                 â”‚
â”‚   è¿™å°±æ˜¯ Linux "ä¸€åˆ‡çš†æ–‡ä»¶" å“²å­¦çš„ä½“ç°                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Cgroup å†…æ ¸æ•°æ®ç»“æ„

ç†è§£ Cgroup çš„å†…æ ¸å®ç°ï¼Œéœ€è¦äº†è§£å‡ ä¸ªæ ¸å¿ƒæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ã€‚

### 2.1 æ ¸å¿ƒç»“æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cgroup æ ¸å¿ƒæ•°æ®ç»“æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ä¸‰ä¸ªæ ¸å¿ƒç»“æ„ï¼š                                                â”‚
â”‚                                                                 â”‚
â”‚   1. cgroup_subsysï¼ˆå­ç³»ç»Ÿ/æ§åˆ¶å™¨ï¼‰                             â”‚
â”‚      â””â”€â”€ å®šä¹‰ä¸€ç§èµ„æºæ§åˆ¶èƒ½åŠ›ï¼ˆå¦‚ cpuã€memoryã€ioï¼‰             â”‚
â”‚                                                                 â”‚
â”‚   2. cgroupï¼ˆæ§åˆ¶ç»„ï¼‰                                           â”‚
â”‚      â””â”€â”€ ä¸€ç»„è¿›ç¨‹çš„é›†åˆï¼Œå¯¹åº”æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªç›®å½•               â”‚
â”‚                                                                 â”‚
â”‚   3. å…·ä½“çš„å­ç³»ç»ŸçŠ¶æ€ç»“æ„ï¼ˆå¦‚ mem_cgroupã€task_groupï¼‰          â”‚
â”‚      â””â”€â”€ å­˜å‚¨è¯¥æ§åˆ¶ç»„åœ¨æŸä¸ªå­ç³»ç»Ÿä¸‹çš„å…·ä½“é…ç½®å’ŒçŠ¶æ€             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 cgroup_subsysï¼ˆå­ç³»ç»Ÿï¼‰

`cgroup_subsys` å®šä¹‰äº†ä¸€ç§èµ„æºæ§åˆ¶å™¨ï¼Œå†…æ ¸ä¸­æœ‰å¤šä¸ªå®ä¾‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cgroup_subsys ç»“æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   struct cgroup_subsys {                                        â”‚
â”‚       // å­ç³»ç»Ÿæ“ä½œå‡½æ•°                                         â”‚
â”‚       struct cgroup_subsys_state *(*css_alloc)(...);            â”‚
â”‚       void (*css_free)(...);                                    â”‚
â”‚       int (*css_online)(...);                                   â”‚
â”‚       void (*css_offline)(...);                                 â”‚
â”‚                                                                 â”‚
â”‚       // è¿›ç¨‹è¿ç§»å›è°ƒ                                           â”‚
â”‚       int (*can_attach)(...);                                   â”‚
â”‚       void (*attach)(...);                                      â”‚
â”‚       void (*fork)(...);                                        â”‚
â”‚       void (*exit)(...);                                        â”‚
â”‚                                                                 â”‚
â”‚       // å­ç³»ç»Ÿæ ‡è¯†                                             â”‚
â”‚       int id;                    // å­ç³»ç»Ÿ ID                   â”‚
â”‚       const char *name;          // å­ç³»ç»Ÿåç§°                  â”‚
â”‚       struct cgroup_root *root;  // æ‰€å±çš„å±‚çº§æ ¹                â”‚
â”‚       ...                                                       â”‚
â”‚   };                                                            â”‚
â”‚                                                                 â”‚
â”‚   å†…æ ¸ä¸­çš„å­ç³»ç»Ÿå®ä¾‹ï¼š                                          â”‚
â”‚   â”œâ”€â”€ cpu_cgrp_subsys      (CPU è°ƒåº¦)                           â”‚
â”‚   â”œâ”€â”€ cpuset_cgrp_subsys   (CPU ç»‘å®š)                           â”‚
â”‚   â”œâ”€â”€ memory_cgrp_subsys   (å†…å­˜é™åˆ¶)                           â”‚
â”‚   â”œâ”€â”€ io_cgrp_subsys       (IO é™åˆ¶)                            â”‚
â”‚   â”œâ”€â”€ pids_cgrp_subsys     (è¿›ç¨‹æ•°é™åˆ¶)                         â”‚
â”‚   â””â”€â”€ ...                                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 cgroup_subsys_stateï¼ˆå­ç³»ç»ŸçŠ¶æ€ï¼‰

æ¯ä¸ªæ§åˆ¶ç»„åœ¨æ¯ä¸ªå­ç³»ç»Ÿä¸‹éƒ½æœ‰ä¸€ä¸ªçŠ¶æ€ç»“æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cgroup_subsys_state (css)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   struct cgroup_subsys_state {                                  â”‚
â”‚       struct cgroup *cgroup;         // æ‰€å±çš„æ§åˆ¶ç»„            â”‚
â”‚       struct cgroup_subsys *ss;      // æ‰€å±çš„å­ç³»ç»Ÿ            â”‚
â”‚       struct cgroup_subsys_state *parent;  // çˆ¶ css            â”‚
â”‚       ...                                                       â”‚
â”‚   };                                                            â”‚
â”‚                                                                 â”‚
â”‚   è¿™æ˜¯ä¸€ä¸ªåŸºç±»ï¼å…·ä½“çš„å­ç³»ç»Ÿä¼šæ‰©å±•å®ƒï¼š                          â”‚
â”‚                                                                 â”‚
â”‚   mem_cgroupï¼ˆå†…å­˜å­ç³»ç»ŸçŠ¶æ€ï¼‰                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ struct mem_cgroup {                                      â”‚  â”‚
â”‚   â”‚     struct cgroup_subsys_state css;  // åµŒå…¥åŸºç±»         â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚     // å†…å­˜é™åˆ¶ç›¸å…³                                      â”‚  â”‚
â”‚   â”‚     struct page_counter memory;      // å†…å­˜è®¡æ•°å™¨       â”‚  â”‚
â”‚   â”‚     struct page_counter swap;        // swap è®¡æ•°å™¨      â”‚  â”‚
â”‚   â”‚     unsigned long soft_limit;        // è½¯é™åˆ¶           â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚     // å†…å­˜ç»Ÿè®¡                                          â”‚  â”‚
â”‚   â”‚     struct mem_cgroup_stat_cpu *stat;                    â”‚  â”‚
â”‚   â”‚     ...                                                  â”‚  â”‚
â”‚   â”‚ };                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   task_groupï¼ˆCPU å­ç³»ç»ŸçŠ¶æ€ï¼‰                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ struct task_group {                                      â”‚  â”‚
â”‚   â”‚     struct cgroup_subsys_state css;  // åµŒå…¥åŸºç±»         â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚     // CFS è°ƒåº¦ç›¸å…³                                      â”‚  â”‚
â”‚   â”‚     struct sched_entity **se;        // è°ƒåº¦å®ä½“æ•°ç»„     â”‚  â”‚
â”‚   â”‚     struct cfs_rq **cfs_rq;          // CFS è¿è¡Œé˜Ÿåˆ—     â”‚  â”‚
â”‚   â”‚     unsigned long shares;            // CPU ä»½é¢         â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚     // å¸¦å®½æ§åˆ¶                                          â”‚  â”‚
â”‚   â”‚     struct cfs_bandwidth cfs_bandwidth;                  â”‚  â”‚
â”‚   â”‚     ...                                                  â”‚  â”‚
â”‚   â”‚ };                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 ç»“æ„ä¹‹é—´çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®ç»“æ„å…³ç³»å›¾                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   cgroup_subsysï¼ˆå­ç³»ç»Ÿå®šä¹‰ï¼‰                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ cpu_cgrp_    â”‚  â”‚ memory_cgrp_ â”‚  â”‚ io_cgrp_     â”‚         â”‚
â”‚   â”‚ subsys       â”‚  â”‚ subsys       â”‚  â”‚ subsys       â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚          â”‚                 â”‚                 â”‚                  â”‚
â”‚          â†“                 â†“                 â†“                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                      cgroupï¼ˆæ§åˆ¶ç»„ï¼‰                     â”‚  â”‚
â”‚   â”‚                      /sys/fs/cgroup/mygroup              â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   subsys_state æ•°ç»„ï¼š                                    â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚   â”‚   â”‚ task_group  â”‚ mem_cgroup  â”‚ io_cgroup   â”‚           â”‚  â”‚
â”‚   â”‚   â”‚ (cpu css)   â”‚ (mem css)   â”‚ (io css)    â”‚           â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                      â”‚
â”‚                          â†“                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    è¿›ç¨‹ï¼ˆtask_structï¼‰                    â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   task->cgroups æŒ‡å‘ css_set                             â”‚  â”‚
â”‚   â”‚   css_set åŒ…å«è¯¥è¿›ç¨‹æ‰€å±çš„æ‰€æœ‰ css                       â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5 ä»æ–‡ä»¶åˆ°å†…æ ¸ç»“æ„çš„æ˜ å°„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ–‡ä»¶ç³»ç»Ÿä¸å†…æ ¸ç»“æ„çš„å¯¹åº”                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   æ–‡ä»¶ç³»ç»Ÿ                          å†…æ ¸ç»“æ„                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   /sys/fs/cgroup/                   cgroup_root                 â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€ mygroup/                  struct cgroup               â”‚
â”‚       â”‚   â”‚                                                     â”‚
â”‚       â”‚   â”œâ”€â”€ cgroup.procs          cgroup->procs (è¿›ç¨‹åˆ—è¡¨)    â”‚
â”‚       â”‚   â”‚                                                     â”‚
â”‚       â”‚   â”œâ”€â”€ cpu.max               task_group->cfs_bandwidth   â”‚
â”‚       â”‚   â”‚                         (é€šè¿‡ css æ‰¾åˆ° task_group)  â”‚
â”‚       â”‚   â”‚                                                     â”‚
â”‚       â”‚   â”œâ”€â”€ memory.max            mem_cgroup->memory.max      â”‚
â”‚       â”‚   â”‚                         (é€šè¿‡ css æ‰¾åˆ° mem_cgroup)  â”‚
â”‚       â”‚   â”‚                                                     â”‚
â”‚       â”‚   â””â”€â”€ io.max                io_cgroup->...              â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â”€ othergroup/               å¦ä¸€ä¸ª struct cgroup        â”‚
â”‚                                                                 â”‚
â”‚   è¯»å†™æ–‡ä»¶æ—¶ï¼š                                                  â”‚
â”‚   1. é€šè¿‡æ–‡ä»¶è·¯å¾„æ‰¾åˆ°å¯¹åº”çš„ cgroup                              â”‚
â”‚   2. é€šè¿‡å­ç³»ç»Ÿ ID æ‰¾åˆ°å¯¹åº”çš„ css                               â”‚
â”‚   3. é€šè¿‡ container_of å®ä» css æ‰¾åˆ°å…·ä½“ç»“æ„ï¼ˆå¦‚ mem_cgroupï¼‰   â”‚
â”‚   4. è¯»å†™å…·ä½“ç»“æ„ä¸­çš„å­—æ®µ                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.6 container_of çš„é­”æ³•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    container_of å®                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   css æ˜¯åŸºç±»ï¼Œå¦‚ä½•ä» css æ‰¾åˆ°åŒ…å«å®ƒçš„ mem_cgroupï¼Ÿ              â”‚
â”‚                                                                 â”‚
â”‚   struct mem_cgroup {                                           â”‚
â”‚       struct cgroup_subsys_state css;  â† css åœ¨ç»“æ„ä½“å¼€å¤´       â”‚
â”‚       struct page_counter memory;                               â”‚
â”‚       ...                                                       â”‚
â”‚   };                                                            â”‚
â”‚                                                                 â”‚
â”‚   // ä» css æŒ‡é’ˆè·å– mem_cgroup æŒ‡é’ˆ                            â”‚
â”‚   struct mem_cgroup *memcg = container_of(css,                  â”‚
â”‚                                           struct mem_cgroup,    â”‚
â”‚                                           css);                 â”‚
â”‚                                                                 â”‚
â”‚   åŸç†ï¼š                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚ mem_cgroup ç»“æ„ä½“                        â”‚                  â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚
â”‚   â”‚ â”‚ css (cgroup_subsys_state)           â”‚ â”‚ â† css æŒ‡é’ˆæŒ‡å‘è¿™ â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚
â”‚   â”‚ â”‚ memory (page_counter)               â”‚ â”‚                  â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚
â”‚   â”‚ ...                                     â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚   â†‘                                                             â”‚
â”‚   mem_cgroup æŒ‡é’ˆ = css æŒ‡é’ˆ - css åœ¨ç»“æ„ä½“ä¸­çš„åç§»é‡           â”‚
â”‚                                                                 â”‚
â”‚   è¿™æ˜¯ Linux å†…æ ¸ä¸­éå¸¸å¸¸è§çš„"ç»§æ‰¿"å®ç°æ–¹å¼                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.7 è¿›ç¨‹ä¸ Cgroup çš„å…³è”

æ¯ä¸ªè¿›ç¨‹éƒ½å…³è”åˆ°ä¸€ç»„ cgroupï¼Œé€šè¿‡ `css_set` ç»“æ„æ¥ç®¡ç†ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¿›ç¨‹ä¸ Cgroup çš„å…³è”                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   task_structï¼ˆè¿›ç¨‹ï¼‰                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ struct task_struct {                                     â”‚  â”‚
â”‚   â”‚     ...                                                  â”‚  â”‚
â”‚   â”‚     struct css_set *cgroups;  // æŒ‡å‘ css_set            â”‚  â”‚
â”‚   â”‚     ...                                                  â”‚  â”‚
â”‚   â”‚ };                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                      â”‚
â”‚                          â†“                                      â”‚
â”‚   css_setï¼ˆcss é›†åˆï¼‰                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ struct css_set {                                         â”‚  â”‚
â”‚   â”‚     struct cgroup_subsys_state *subsys[CGROUP_SUBSYS_COUNT];â”‚
â”‚   â”‚     //                          â†‘                        â”‚  â”‚
â”‚   â”‚     //  æ•°ç»„ï¼Œæ¯ä¸ªå­ç³»ç»Ÿä¸€ä¸ª css æŒ‡é’ˆ                    â”‚  â”‚
â”‚   â”‚     //  subsys[cpu_id]    â†’ task_group çš„ css            â”‚  â”‚
â”‚   â”‚     //  subsys[memory_id] â†’ mem_cgroup çš„ css            â”‚  â”‚
â”‚   â”‚     //  subsys[io_id]     â†’ io_cgroup çš„ css             â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚     struct list_head tasks;  // ä½¿ç”¨æ­¤ css_set çš„è¿›ç¨‹åˆ—è¡¨â”‚  â”‚
â”‚   â”‚     ...                                                  â”‚  â”‚
â”‚   â”‚ };                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.8 ä¸ºä»€ä¹ˆéœ€è¦ css_setï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    css_set çš„ä½œç”¨                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   é—®é¢˜ï¼šä¸€ä¸ªè¿›ç¨‹å¯èƒ½å±äºå¤šä¸ªä¸åŒçš„ cgroup                       â”‚
â”‚                                                                 â”‚
â”‚   ä¾‹å¦‚ï¼šè¿›ç¨‹ P çš„èµ„æºé™åˆ¶é…ç½®                                   â”‚
â”‚   â”œâ”€â”€ CPU é™åˆ¶ï¼šå±äº /sys/fs/cgroup/app/web                     â”‚
â”‚   â”œâ”€â”€ å†…å­˜é™åˆ¶ï¼šå±äº /sys/fs/cgroup/app/web                     â”‚
â”‚   â””â”€â”€ IO é™åˆ¶ï¼šå±äº /sys/fs/cgroup/app/database                 â”‚
â”‚                                                                 â”‚
â”‚   css_set å°±æ˜¯æŠŠè¿›ç¨‹åœ¨å„ä¸ªå­ç³»ç»Ÿçš„ css æ‰“åŒ…åœ¨ä¸€èµ·ï¼š             â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                     css_set                              â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚   â”‚  â”‚ subsys[cpu_id]    â”€â”€â†’ /app/web çš„ task_group    â”‚    â”‚  â”‚
â”‚   â”‚  â”‚ subsys[memory_id] â”€â”€â†’ /app/web çš„ mem_cgroup    â”‚    â”‚  â”‚
â”‚   â”‚  â”‚ subsys[io_id]     â”€â”€â†’ /app/database çš„ io_cgroupâ”‚    â”‚  â”‚
â”‚   â”‚  â”‚ ...                                              â”‚    â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†‘                                      â”‚
â”‚                          â”‚                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚   â”‚ è¿›ç¨‹ P1  â”‚  â”‚ è¿›ç¨‹ P2  â”‚  â”‚ è¿›ç¨‹ P3  â”‚                     â”‚
â”‚   â”‚ cgroups â”€â”¼â”€â”€â”¼â”€â†’        â”‚  â”‚ cgroups â”€â”¼â”€â”€â†’ å¦ä¸€ä¸ª css_set   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                 â”‚
â”‚   ä¼˜åŒ–ï¼šç›¸åŒ cgroup é…ç½®çš„è¿›ç¨‹å…±äº«åŒä¸€ä¸ª css_set                â”‚
â”‚         P1 å’Œ P2 å¦‚æœåœ¨ç›¸åŒçš„ cgroup ç»„åˆä¸­ï¼Œå…±äº« css_set       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.9 å®Œæ•´çš„å…³è”å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®Œæ•´å…³è”å…³ç³»å›¾                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   cgroup_subsysï¼ˆå­ç³»ç»Ÿå®šä¹‰ï¼Œå…¨å±€å”¯ä¸€ï¼‰                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚cpu_cgrp_   â”‚ â”‚memory_cgrp_â”‚ â”‚io_cgrp_    â”‚                 â”‚
â”‚   â”‚subsys      â”‚ â”‚subsys      â”‚ â”‚subsys      â”‚                 â”‚
â”‚   â”‚ id=0       â”‚ â”‚ id=1       â”‚ â”‚ id=2       â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚              â”‚              â”‚                         â”‚
â”‚         â†“              â†“              â†“                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚              cgroupï¼ˆ/sys/fs/cgroup/mygroupï¼‰            â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   css æ•°ç»„ï¼š                                             â”‚  â”‚
â”‚   â”‚   [0] â”€â”€â†’ task_group { css, shares, cfs_bandwidth... }   â”‚  â”‚
â”‚   â”‚   [1] â”€â”€â†’ mem_cgroup { css, memory.max, memory.high... } â”‚  â”‚
â”‚   â”‚   [2] â”€â”€â†’ io_cgroup  { css, io.max... }                  â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†‘                                      â”‚
â”‚                          â”‚ css_set->subsys[] æŒ‡å‘è¿™äº› css       â”‚
â”‚                          â”‚                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                      css_set                             â”‚  â”‚
â”‚   â”‚   subsys[0] â”€â”€â†’ task_group çš„ css                        â”‚  â”‚
â”‚   â”‚   subsys[1] â”€â”€â†’ mem_cgroup çš„ css                        â”‚  â”‚
â”‚   â”‚   subsys[2] â”€â”€â†’ io_cgroup çš„ css                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†‘                                      â”‚
â”‚                          â”‚ task->cgroups                        â”‚
â”‚                          â”‚                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚   â”‚ è¿›ç¨‹ A   â”‚  â”‚ è¿›ç¨‹ B   â”‚  â”‚ è¿›ç¨‹ C   â”‚                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                 â”‚
â”‚   æŸ¥æ‰¾è·¯å¾„ï¼š                                                    â”‚
â”‚   è¿›ç¨‹ â†’ css_set â†’ css â†’ å…·ä½“ç»“æ„ï¼ˆmem_cgroup/task_groupï¼‰     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.10 å°†è¿›ç¨‹åŠ å…¥ Cgroup çš„è¿‡ç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¿›ç¨‹åŠ å…¥ Cgroup                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   å½“æ‰§è¡Œ echo $PID > /sys/fs/cgroup/mygroup/cgroup.procs        â”‚
â”‚                                                                 â”‚
â”‚   1. å†…æ ¸æ‰¾åˆ°ç›®æ ‡ cgroup                                        â”‚
â”‚      â””â”€â”€ é€šè¿‡æ–‡ä»¶è·¯å¾„æ‰¾åˆ° struct cgroup                         â”‚
â”‚                                                                 â”‚
â”‚   2. æŸ¥æ‰¾æˆ–åˆ›å»º css_set                                         â”‚
â”‚      â””â”€â”€ æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒ¹é…çš„ css_setï¼ˆç›¸åŒçš„ css ç»„åˆï¼‰          â”‚
â”‚      â””â”€â”€ æ²¡æœ‰åˆ™åˆ›å»ºæ–°çš„ css_set                                 â”‚
â”‚                                                                 â”‚
â”‚   3. æ›´æ–°è¿›ç¨‹çš„ cgroups æŒ‡é’ˆ                                    â”‚
â”‚      â””â”€â”€ task->cgroups = new_css_set                            â”‚
â”‚                                                                 â”‚
â”‚   4. è°ƒç”¨å„å­ç³»ç»Ÿçš„ attach å›è°ƒ                                 â”‚
â”‚      â””â”€â”€ è®©å­ç³»ç»ŸçŸ¥é“æœ‰æ–°è¿›ç¨‹åŠ å…¥                               â”‚
â”‚      â””â”€â”€ å¦‚ CPU å­ç³»ç»Ÿæ›´æ–°è°ƒåº¦é˜Ÿåˆ—                              â”‚
â”‚                                                                 â”‚
â”‚   5. èµ„æºé™åˆ¶ç«‹å³ç”Ÿæ•ˆ                                           â”‚
â”‚      â””â”€â”€ è¿›ç¨‹çš„èµ„æºä½¿ç”¨å—åˆ°æ–° cgroup çš„é™åˆ¶                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. CPU èµ„æºé™åˆ¶

### 3.1 task_group çš„æ ‘å½¢ç»“æ„

é¦–å…ˆè¦ç†è§£ï¼š**task_group ä¸æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œè€Œæ˜¯æ¯ä¸ª cgroup ä¸€ä¸ª**ï¼Œå®ƒä»¬å½¢æˆæ ‘å½¢ç»“æ„ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    task_group çš„æ ‘å½¢ç»“æ„                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Cgroup æ–‡ä»¶ç³»ç»Ÿï¼š                    task_group ç»“æ„ï¼š        â”‚
â”‚                                                                 â”‚
â”‚   /sys/fs/cgroup/                      root_task_group          â”‚
â”‚       â”‚                                     â”‚                   â”‚
â”‚       â”œâ”€â”€ groupA/                      task_group (groupA)      â”‚
â”‚       â”‚     â”‚                               â”‚                   â”‚
â”‚       â”‚     â””â”€â”€ subA/                  task_group (subA)        â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â”€ groupB/                      task_group (groupB)      â”‚
â”‚                                                                 â”‚
â”‚   æ¯ä¸ª cgroup ç›®å½•å¯¹åº”ä¸€ä¸ª task_group                           â”‚
â”‚   å®ƒä»¬å½¢æˆå’Œ cgroup ç›®å½•ä¸€æ ·çš„æ ‘å½¢ç»“æ„                          â”‚
â”‚                                                                 â”‚
â”‚   root_task_groupï¼š                                             â”‚
â”‚   â”œâ”€â”€ å†…æ ¸å¯åŠ¨æ—¶åˆ›å»ºçš„é»˜è®¤ task_group                           â”‚
â”‚   â”œâ”€â”€ å¯¹åº” cgroup çš„æ ¹ç›®å½• /sys/fs/cgroup/                      â”‚
â”‚   â””â”€â”€ æ²¡æœ‰åŠ å…¥ä»»ä½• cgroup çš„è¿›ç¨‹éƒ½å±äºå®ƒ                        â”‚
â”‚                                                                 â”‚
â”‚   // kernel/sched/core.c                                        â”‚
â”‚   struct task_group root_task_group;  // å…¨å±€å˜é‡               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 task_group å†…éƒ¨çš„ per-CPU ç»“æ„

æ¯ä¸ª `task_group` å†…éƒ¨æœ‰ **per-CPU çš„è°ƒåº¦é˜Ÿåˆ—**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    task_group å†…éƒ¨ç»“æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   struct task_group {                                           â”‚
â”‚       struct cgroup_subsys_state css;                           â”‚
â”‚                                                                 â”‚
â”‚       // æ¯ä¸ª CPU ä¸€ä¸ªè°ƒåº¦å®ä½“                                  â”‚
â”‚       struct sched_entity **se;      // æ•°ç»„ï¼Œé•¿åº¦ = CPU æ ¸æ•°   â”‚
â”‚                                                                 â”‚
â”‚       // æ¯ä¸ª CPU ä¸€ä¸ª CFS è¿è¡Œé˜Ÿåˆ—                             â”‚
â”‚       struct cfs_rq **cfs_rq;        // æ•°ç»„ï¼Œé•¿åº¦ = CPU æ ¸æ•°   â”‚
â”‚                                                                 â”‚
â”‚       unsigned long shares;          // CPU ä»½é¢ï¼ˆæƒé‡ï¼‰        â”‚
â”‚       struct cfs_bandwidth cfs_bandwidth;  // å¸¦å®½æ§åˆ¶ï¼ˆå…¨å±€ï¼‰  â”‚
â”‚       ...                                                       â”‚
â”‚   };                                                            â”‚
â”‚                                                                 â”‚
â”‚   å…³é”®ç†è§£ï¼š                                                    â”‚
â”‚   â”œâ”€â”€ task_group æ˜¯å…¨å±€çš„ï¼ˆä¸€ä¸ª cgroup ä¸€ä¸ªï¼‰                   â”‚
â”‚   â”œâ”€â”€ se[] å’Œ cfs_rq[] æ˜¯ per-CPU çš„ï¼ˆæ¯ä¸ª CPU ä¸€ä»½ï¼‰           â”‚
â”‚   â””â”€â”€ cfs_bandwidth æ˜¯å…¨å±€çš„ï¼ˆæ•´ä¸ª task_group å…±äº«é…é¢ï¼‰        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 cfs_rq å’Œ se çš„å±‚çº§å…³ç³»

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šseï¼ˆè°ƒåº¦å®ä½“ï¼‰å¯ä»¥æ˜¯è¿›ç¨‹ï¼Œä¹Ÿå¯ä»¥æŒ‡å‘ä¸‹ä¸€å±‚ cfs_rqï¼ˆç»„ï¼‰ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cfs_rq å’Œ se çš„å±‚çº§å…³ç³»                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   æ¯ä¸ª CPU æœ‰ä¸€ä¸ªæ ¹ cfs_rq                                      â”‚
â”‚                                                                 â”‚
â”‚   seï¼ˆè°ƒåº¦å®ä½“ï¼‰å¯ä»¥æ˜¯ï¼š                                        â”‚
â”‚   â”œâ”€â”€ è¿›ç¨‹çš„ seï¼ˆå¶å­èŠ‚ç‚¹ï¼‰                                     â”‚
â”‚   â””â”€â”€ task_group çš„ seï¼ˆæŒ‡å‘ä¸‹ä¸€å±‚ cfs_rqï¼‰                     â”‚
â”‚                                                                 â”‚
â”‚   CPU 0 çš„è°ƒåº¦ç»“æ„ï¼š                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   æ ¹ cfs_rq (CPU 0)  â† å±äº root_task_group              â”‚  â”‚
â”‚   â”‚       â”‚                                                  â”‚  â”‚
â”‚   â”‚       â”œâ”€â”€ se (è¿›ç¨‹ P1)        â† ç›´æ¥æ˜¯è¿›ç¨‹               â”‚  â”‚
â”‚   â”‚       â”‚                                                  â”‚  â”‚
â”‚   â”‚       â”œâ”€â”€ se (groupA) â”€â”€â”€â”€â”€â”€â†’ groupA çš„ cfs_rq[0]       â”‚  â”‚
â”‚   â”‚       â”‚                           â”‚                      â”‚  â”‚
â”‚   â”‚       â”‚                           â”œâ”€â”€ se (è¿›ç¨‹ A1)       â”‚  â”‚
â”‚   â”‚       â”‚                           â”œâ”€â”€ se (è¿›ç¨‹ A2)       â”‚  â”‚
â”‚   â”‚       â”‚                           â””â”€â”€ se (subA) â”€â”€â”€â”€â†’ ...â”‚  â”‚
â”‚   â”‚       â”‚                                                  â”‚  â”‚
â”‚   â”‚       â””â”€â”€ se (groupB) â”€â”€â”€â”€â”€â”€â†’ groupB çš„ cfs_rq[0]       â”‚  â”‚
â”‚   â”‚                                   â”‚                      â”‚  â”‚
â”‚   â”‚                                   â”œâ”€â”€ se (è¿›ç¨‹ B1)       â”‚  â”‚
â”‚   â”‚                                   â””â”€â”€ se (è¿›ç¨‹ B2)       â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   cfs_rq çš„ä¸¤ç§å«ä¹‰ï¼š                                           â”‚
â”‚   â”œâ”€â”€ æ ¹ cfs_rqï¼šCPU çš„ä¸»è¿è¡Œé˜Ÿåˆ—ï¼ˆå±äº root_task_groupï¼‰       â”‚
â”‚   â””â”€â”€ ç»„çš„ cfs_rqï¼štask_group åœ¨è¯¥ CPU ä¸Šçš„"å­é˜Ÿåˆ—"             â”‚
â”‚                    ç®¡ç†å±äºè¯¥ç»„ã€åœ¨è¯¥ CPU ä¸Šè¿è¡Œçš„è¿›ç¨‹          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 è°ƒåº¦è¿‡ç¨‹ï¼šé€’å½’éå†æ ‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è°ƒåº¦è¿‡ç¨‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   pick_next_task_fair():                                        â”‚
â”‚                                                                 â”‚
â”‚   1. ä»æ ¹ cfs_rq é€‰ vruntime æœ€å°çš„ se                          â”‚
â”‚      â†’ å‡è®¾é€‰ä¸­ groupA çš„ se                                    â”‚
â”‚                                                                 â”‚
â”‚   2. å‘ç°è¿™ä¸ª se æ˜¯ç»„ï¼Œè¿›å…¥ groupA çš„ cfs_rq                    â”‚
â”‚      â†’ ç»§ç»­é€‰ vruntime æœ€å°çš„ se                                â”‚
â”‚      â†’ å‡è®¾é€‰ä¸­è¿›ç¨‹ A1 çš„ se                                    â”‚
â”‚                                                                 â”‚
â”‚   3. å‘ç°è¿™ä¸ª se æ˜¯è¿›ç¨‹ï¼Œè¿”å›è¿›ç¨‹ A1                            â”‚
â”‚                                                                 â”‚
â”‚   ä»£ç ç®€åŒ–ï¼š                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  while (se ä¸æ˜¯è¿›ç¨‹) {                                   â”‚  â”‚
â”‚   â”‚      cfs_rq = group_cfs_rq(se);  // è¿›å…¥ç»„çš„ cfs_rq      â”‚  â”‚
â”‚   â”‚      se = pick_next_entity(cfs_rq);  // é€‰æœ€å° vruntime  â”‚  â”‚
â”‚   â”‚  }                                                       â”‚  â”‚
â”‚   â”‚  return task_of(se);  // è¿”å›è¿›ç¨‹                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.5 å®Œæ•´çš„ 4 æ ¸ç³»ç»Ÿç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    4 æ ¸ç³»ç»Ÿçš„ task_group                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   task_group (groupA)                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   se[4] æ•°ç»„ï¼š                                           â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚   â”‚   â”‚ se[0]  â”‚ se[1]  â”‚ se[2]  â”‚ se[3]  â”‚                 â”‚  â”‚
â”‚   â”‚   â”‚ CPU 0  â”‚ CPU 1  â”‚ CPU 2  â”‚ CPU 3  â”‚                 â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   cfs_rq[4] æ•°ç»„ï¼š                                       â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚   â”‚   â”‚cfs_rq  â”‚cfs_rq  â”‚cfs_rq  â”‚cfs_rq  â”‚                 â”‚  â”‚
â”‚   â”‚   â”‚  [0]   â”‚  [1]   â”‚  [2]   â”‚  [3]   â”‚                 â”‚  â”‚
â”‚   â”‚   â”‚        â”‚        â”‚        â”‚        â”‚                 â”‚  â”‚
â”‚   â”‚   â”‚ è¿›ç¨‹   â”‚ è¿›ç¨‹   â”‚ è¿›ç¨‹   â”‚ è¿›ç¨‹   â”‚                 â”‚  â”‚
â”‚   â”‚   â”‚ A1,A2  â”‚ A3     â”‚ A4,A5  â”‚ (ç©º)   â”‚                 â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   cfs_bandwidthï¼ˆå…¨å±€é…é¢æ± ï¼Œåªæœ‰ä¸€ä¸ªï¼‰                  â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   æ¯ä¸ª CPU æ ¸å¿ƒï¼š                                               â”‚
â”‚   â”œâ”€â”€ se[cpu]ï¼šgroupA åœ¨è¯¥ CPU ä¸Šçš„è°ƒåº¦å®ä½“ï¼Œå‚ä¸æ ¹é˜Ÿåˆ—è°ƒåº¦     â”‚
â”‚   â””â”€â”€ cfs_rq[cpu]ï¼šgroupA åœ¨è¯¥ CPU ä¸Šçš„å†…éƒ¨é˜Ÿåˆ—ï¼Œç®¡ç†ç»„å†…è¿›ç¨‹   â”‚
â”‚                                                                 â”‚
â”‚   è¿›ç¨‹åˆ†å¸ƒï¼š                                                    â”‚
â”‚   â”œâ”€â”€ è¿›ç¨‹ A1ã€A2 åœ¨ CPU 0 ä¸Šè¿è¡Œï¼Œåœ¨ cfs_rq[0] ä¸­è°ƒåº¦          â”‚
â”‚   â”œâ”€â”€ è¿›ç¨‹ A3 åœ¨ CPU 1 ä¸Šè¿è¡Œï¼Œåœ¨ cfs_rq[1] ä¸­è°ƒåº¦              â”‚
â”‚   â”œâ”€â”€ è¿›ç¨‹ A4ã€A5 åœ¨ CPU 2 ä¸Šè¿è¡Œï¼Œåœ¨ cfs_rq[2] ä¸­è°ƒåº¦          â”‚
â”‚   â””â”€â”€ CPU 3 ä¸Šæ²¡æœ‰ groupA çš„è¿›ç¨‹                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.6 ç»„è°ƒåº¦ä¸æ™®é€šè°ƒåº¦çš„å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç»„è°ƒåº¦ vs æ™®é€šè°ƒåº¦                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   æ²¡æœ‰ Cgroupï¼ˆæ™®é€šè°ƒåº¦ï¼‰ï¼š                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚              æ ¹ cfs_rq (CPU 0)                           â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   è¿›ç¨‹1çš„se  è¿›ç¨‹2çš„se  è¿›ç¨‹3çš„se  è¿›ç¨‹4çš„se             â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   æ‰€æœ‰è¿›ç¨‹ç›´æ¥åœ¨æ ¹é˜Ÿåˆ—ä¸­ç«äº‰                             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   æœ‰ Cgroupï¼ˆç»„è°ƒåº¦ï¼‰ï¼š                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚              æ ¹ cfs_rq (CPU 0)                           â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   groupAçš„se[0]        groupBçš„se[0]                     â”‚  â”‚
â”‚   â”‚        â”‚                    â”‚                            â”‚  â”‚
â”‚   â”‚        â†“                    â†“                            â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚  â”‚
â”‚   â”‚   â”‚ groupA  â”‚          â”‚ groupB  â”‚                      â”‚  â”‚
â”‚   â”‚   â”‚ cfs_rq  â”‚          â”‚ cfs_rq  â”‚                      â”‚  â”‚
â”‚   â”‚   â”‚         â”‚          â”‚         â”‚                      â”‚  â”‚
â”‚   â”‚   â”‚ è¿›ç¨‹1   â”‚          â”‚ è¿›ç¨‹3   â”‚                      â”‚  â”‚
â”‚   â”‚   â”‚ è¿›ç¨‹2   â”‚          â”‚ è¿›ç¨‹4   â”‚                      â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   å…ˆé€‰ç»„ï¼Œå†é€‰ç»„å†…è¿›ç¨‹                                   â”‚  â”‚
â”‚   â”‚   ç»„ä¹‹é—´æŒ‰ shares/weight åˆ†é… CPU æ—¶é—´                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.7 å†…æ ¸ä»£ç ï¼šåˆ›å»º Cgroup

å½“æ‰§è¡Œ `mkdir /sys/fs/cgroup/mygroup` æ—¶ï¼Œå†…æ ¸çš„ç®€åŒ–æµç¨‹ï¼š

```c
// åˆ›å»º cgroup çš„ç®€åŒ–ä»£ç æµç¨‹
// fs/cgroup/cgroup.c

// 1. mkdir è§¦å‘ cgroup_mkdir()
static int cgroup_mkdir(struct kernfs_node *parent, const char *name, umode_t mode)
{
    struct cgroup *parent_cgrp = parent->priv;
    struct cgroup *cgrp;
    
    // 2. åˆ†é…æ–°çš„ cgroup ç»“æ„
    cgrp = kzalloc(sizeof(*cgrp), GFP_KERNEL);
    
    // 3. åˆå§‹åŒ– cgroup
    cgroup_init_cgrp(cgrp, parent_cgrp);
    
    // 4. ä¸ºæ¯ä¸ªå¯ç”¨çš„å­ç³»ç»Ÿåˆ›å»º css
    for_each_subsys(ss, ssid) {
        if (cgroup_subsys_on_dfl(ss)) {
            // è°ƒç”¨å­ç³»ç»Ÿçš„ css_alloc å›è°ƒ
            css = ss->css_alloc(parent_css);
            
            // ä¾‹å¦‚ CPU å­ç³»ç»Ÿä¼šåˆ›å»º task_group
            // memory å­ç³»ç»Ÿä¼šåˆ›å»º mem_cgroup
        }
    }
    
    // 5. åˆ›å»ºæ§åˆ¶æ–‡ä»¶ï¼ˆcpu.max, memory.max ç­‰ï¼‰
    cgroup_populate_dir(cgrp);
    
    return 0;
}

// CPU å­ç³»ç»Ÿçš„ css_alloc å®ç°
static struct cgroup_subsys_state *cpu_cgroup_css_alloc(struct cgroup_subsys_state *parent_css)
{
    struct task_group *tg;
    
    // åˆ†é… task_group
    tg = sched_create_group(parent_css ? css_tg(parent_css) : NULL);
    
    // task_group å†…éƒ¨ä¼šä¸ºæ¯ä¸ª CPU åˆ†é… se å’Œ cfs_rq
    // alloc_fair_sched_group() ä¸­ï¼š
    //   tg->se = kcalloc(nr_cpu_ids, sizeof(*tg->se), GFP_KERNEL);
    //   tg->cfs_rq = kcalloc(nr_cpu_ids, sizeof(*tg->cfs_rq), GFP_KERNEL);
    
    return &tg->css;
}
```

### 3.7 å†…æ ¸ä»£ç ï¼šå°†è¿›ç¨‹åŠ å…¥ Cgroup

å½“æ‰§è¡Œ `echo $PID > /sys/fs/cgroup/mygroup/cgroup.procs` æ—¶ï¼š

```c
// å°†è¿›ç¨‹åŠ å…¥ cgroup çš„ç®€åŒ–ä»£ç æµç¨‹
// fs/cgroup/cgroup.c

// 1. å†™å…¥ cgroup.procs è§¦å‘ cgroup_procs_write()
static ssize_t cgroup_procs_write(struct kernfs_open_file *of,
                                   char *buf, size_t nbytes, loff_t off)
{
    struct cgroup *dst_cgrp = of->kn->parent->priv;
    struct task_struct *task;
    pid_t pid;
    
    // 2. è§£æ PID
    pid = simple_strtol(buf, NULL, 10);
    
    // 3. æ‰¾åˆ°å¯¹åº”çš„è¿›ç¨‹
    task = find_task_by_vpid(pid);
    
    // 4. æ‰§è¡Œè¿ç§»
    cgroup_migrate(task, dst_cgrp);
    
    return nbytes;
}

// è¿ç§»è¿›ç¨‹åˆ°æ–° cgroup
static int cgroup_migrate(struct task_struct *task, struct cgroup *dst_cgrp)
{
    struct css_set *old_cset = task->cgroups;
    struct css_set *new_cset;
    
    // 5. æŸ¥æ‰¾æˆ–åˆ›å»ºæ–°çš„ css_set
    //    æ–° css_set åŒ…å«ç›®æ ‡ cgroup çš„å„ä¸ª css
    new_cset = find_css_set(old_cset, dst_cgrp);
    
    // 6. è°ƒç”¨å„å­ç³»ç»Ÿçš„ can_attach æ£€æŸ¥
    for_each_subsys(ss, ssid) {
        if (ss->can_attach) {
            ret = ss->can_attach(dst_css);
            if (ret)
                return ret;
        }
    }
    
    // 7. æ›´æ–°è¿›ç¨‹çš„ cgroups æŒ‡é’ˆ
    rcu_assign_pointer(task->cgroups, new_cset);
    
    // 8. è°ƒç”¨å„å­ç³»ç»Ÿçš„ attach å›è°ƒ
    for_each_subsys(ss, ssid) {
        if (ss->attach) {
            ss->attach(dst_css, task);
        }
    }
    
    return 0;
}

// CPU å­ç³»ç»Ÿçš„ attach å®ç°
static void cpu_cgroup_attach(struct cgroup_taskset *tset)
{
    struct task_struct *task;
    struct cgroup_subsys_state *css;
    
    // å°†è¿›ç¨‹ç§»åŠ¨åˆ°æ–°çš„è°ƒåº¦ç»„
    cgroup_taskset_for_each(task, css, tset) {
        // ä»æ—§çš„ cfs_rq ç§»é™¤
        // åŠ å…¥æ–°çš„ task_group çš„ cfs_rq
        sched_move_task(task);
    }
}
```

### 3.8 å…³é”®æµç¨‹æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åˆ›å»º Cgroup æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   mkdir /sys/fs/cgroup/mygroup                                  â”‚
â”‚                 â”‚                                               â”‚
â”‚                 â†“                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 1. cgroup_mkdir()                                        â”‚  â”‚
â”‚   â”‚    â””â”€â”€ åˆ†é… struct cgroup                                â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚ 2. éå†æ‰€æœ‰å¯ç”¨çš„å­ç³»ç»Ÿ                                  â”‚  â”‚
â”‚   â”‚    â””â”€â”€ è°ƒç”¨ ss->css_alloc()                              â”‚  â”‚
â”‚   â”‚        â”œâ”€â”€ cpu: åˆ›å»º task_groupï¼ˆå« se[], cfs_rq[]ï¼‰     â”‚  â”‚
â”‚   â”‚        â”œâ”€â”€ memory: åˆ›å»º mem_cgroup                       â”‚  â”‚
â”‚   â”‚        â””â”€â”€ io: åˆ›å»º io_cgroup                            â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚ 3. åˆ›å»ºæ§åˆ¶æ–‡ä»¶                                          â”‚  â”‚
â”‚   â”‚    â””â”€â”€ cpu.max, memory.max, io.max ç­‰                    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¿›ç¨‹åŠ å…¥ Cgroup æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   echo $PID > /sys/fs/cgroup/mygroup/cgroup.procs               â”‚
â”‚                 â”‚                                               â”‚
â”‚                 â†“                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ 1. cgroup_procs_write()                                  â”‚  â”‚
â”‚   â”‚    â””â”€â”€ è§£æ PIDï¼Œæ‰¾åˆ° task_struct                        â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚ 2. find_css_set()                                        â”‚  â”‚
â”‚   â”‚    â””â”€â”€ æŸ¥æ‰¾æˆ–åˆ›å»ºåŒ…å«æ–° css ç»„åˆçš„ css_set               â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚ 3. è°ƒç”¨ ss->can_attach() æ£€æŸ¥                            â”‚  â”‚
â”‚   â”‚    â””â”€â”€ å„å­ç³»ç»Ÿæ£€æŸ¥æ˜¯å¦å…è®¸è¿ç§»                          â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚ 4. æ›´æ–° task->cgroups æŒ‡é’ˆ                               â”‚  â”‚
â”‚   â”‚    â””â”€â”€ æŒ‡å‘æ–°çš„ css_set                                  â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚ 5. è°ƒç”¨ ss->attach() å›è°ƒ                                â”‚  â”‚
â”‚   â”‚    â”œâ”€â”€ cpu: sched_move_task() ç§»åŠ¨åˆ°æ–°è°ƒåº¦é˜Ÿåˆ—           â”‚  â”‚
â”‚   â”‚    â”œâ”€â”€ memory: æ›´æ–°å†…å­˜è®¡æ•°                              â”‚  â”‚
â”‚   â”‚    â””â”€â”€ io: æ›´æ–° IO é™åˆ¶                                  â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚ 6. èµ„æºé™åˆ¶ç«‹å³ç”Ÿæ•ˆ                                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.9 CPU æƒé‡ï¼ˆWeightï¼‰ä¸ vruntime

CPU Cgroup é€šè¿‡**æƒé‡ï¼ˆweightï¼‰**æ¥æ§åˆ¶å„ç»„åˆ†é…åˆ°çš„ CPU æ—¶é—´æ¯”ä¾‹ï¼Œåº•å±‚åŸç†æ˜¯å½±å“ **vruntime** çš„å¢é•¿é€Ÿåº¦ã€‚

#### æƒé‡çš„æ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CPU æƒé‡ï¼ˆWeightï¼‰                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Cgroup v1: cpu.sharesï¼ˆé»˜è®¤ 1024ï¼‰                            â”‚
â”‚   Cgroup v2: cpu.weightï¼ˆé»˜è®¤ 100ï¼ŒèŒƒå›´ 1-10000ï¼‰               â”‚
â”‚                                                                 â”‚
â”‚   æƒé‡æ˜¯ç›¸å¯¹å€¼ï¼Œå†³å®š CPU æ—¶é—´çš„åˆ†é…æ¯”ä¾‹ï¼š                       â”‚
â”‚                                                                 â”‚
â”‚   ç¤ºä¾‹ï¼š4 æ ¸ CPUï¼Œä¸¤ä¸ªå®¹å™¨                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  å®¹å™¨ A: weight = 100                                    â”‚  â”‚
â”‚   â”‚  å®¹å™¨ B: weight = 300                                    â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚  æ€»æƒé‡ = 100 + 300 = 400                                â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚  å®¹å™¨ A åˆ†é…æ¯”ä¾‹ = 100/400 = 25%                         â”‚  â”‚
â”‚   â”‚  å®¹å™¨ B åˆ†é…æ¯”ä¾‹ = 300/400 = 75%                         â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚  4 æ ¸ CPU çš„åˆ†é…ï¼š                                       â”‚  â”‚
â”‚   â”‚  å®¹å™¨ A â‰ˆ 4 Ã— 25% = 1 æ ¸                                 â”‚  â”‚
â”‚   â”‚  å®¹å™¨ B â‰ˆ 4 Ã— 75% = 3 æ ¸                                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   æ³¨æ„ï¼šè¿™æ˜¯"è½¯é™åˆ¶"ï¼Œåªåœ¨ CPU ç«äº‰æ—¶ç”Ÿæ•ˆ                       â”‚
â”‚         å¦‚æœåªæœ‰å®¹å™¨ A åœ¨è¿è¡Œï¼Œå®ƒå¯ä»¥ç”¨æ»¡ 4 æ ¸                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æƒé‡å¦‚ä½•å½±å“ vruntime

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æƒé‡ä¸ vruntime çš„å…³ç³»                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   CFS è°ƒåº¦å™¨é€‰æ‹© vruntime æœ€å°çš„ä»»åŠ¡è¿è¡Œ                        â”‚
â”‚                                                                 â”‚
â”‚   vruntime å¢é•¿å…¬å¼ï¼š                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   vruntime += å®é™…è¿è¡Œæ—¶é—´ Ã— (NICE_0_LOAD / æƒé‡)        â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   NICE_0_LOAD = 1024ï¼ˆåŸºå‡†æƒé‡ï¼‰                         â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   æƒé‡è¶Šå¤§ï¼Œvruntime å¢é•¿è¶Šæ…¢ï¼š                                 â”‚
â”‚   â”œâ”€â”€ æƒé‡ = 1024ï¼švruntime å¢é•¿ = å®é™…æ—¶é—´ Ã— 1               â”‚
â”‚   â”œâ”€â”€ æƒé‡ = 2048ï¼švruntime å¢é•¿ = å®é™…æ—¶é—´ Ã— 0.5             â”‚
â”‚   â””â”€â”€ æƒé‡ = 512ï¼š vruntime å¢é•¿ = å®é™…æ—¶é—´ Ã— 2               â”‚
â”‚                                                                 â”‚
â”‚   vruntime å¢é•¿æ…¢ â†’ æ›´å®¹æ˜“è¢«é€‰ä¸­ â†’ è·å¾—æ›´å¤š CPU æ—¶é—´            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç»„è°ƒåº¦ä¸­çš„ vruntime

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç»„è°ƒåº¦çš„ vruntime è®¡ç®—                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ä¸¤å±‚ vruntimeï¼š                                               â”‚
â”‚                                                                 â”‚
â”‚   1. ç»„çº§åˆ«çš„ vruntimeï¼ˆtask_group çš„ seï¼‰                      â”‚
â”‚      â””â”€â”€ å†³å®šå“ªä¸ªç»„å…ˆè¢«è°ƒåº¦                                     â”‚
â”‚                                                                 â”‚
â”‚   2. è¿›ç¨‹çº§åˆ«çš„ vruntimeï¼ˆè¿›ç¨‹çš„ seï¼‰                           â”‚
â”‚      â””â”€â”€ å†³å®šç»„å†…å“ªä¸ªè¿›ç¨‹å…ˆè¿è¡Œ                                 â”‚
â”‚                                                                 â”‚
â”‚   ç¤ºä¾‹ï¼š                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚              æ ¹ cfs_rq                                   â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   groupA (weight=100)      groupB (weight=300)           â”‚  â”‚
â”‚   â”‚   se.vruntime = 1000       se.vruntime = 800             â”‚  â”‚
â”‚   â”‚        â”‚                        â”‚                        â”‚  â”‚
â”‚   â”‚        â”‚                        â†“ é€‰ä¸­ï¼ˆvruntime æ›´å°ï¼‰  â”‚  â”‚
â”‚   â”‚        â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚
â”‚   â”‚        â”‚                   â”‚ groupB  â”‚                   â”‚  â”‚
â”‚   â”‚        â”‚                   â”‚ cfs_rq  â”‚                   â”‚  â”‚
â”‚   â”‚        â”‚                   â”‚         â”‚                   â”‚  â”‚
â”‚   â”‚        â”‚                   â”‚ P1: 500 â”‚ â† é€‰ä¸­            â”‚  â”‚
â”‚   â”‚        â”‚                   â”‚ P2: 600 â”‚                   â”‚  â”‚
â”‚   â”‚        â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   groupB çš„ vruntime å°ï¼Œå…ˆè¢«é€‰ä¸­                        â”‚  â”‚
â”‚   â”‚   ç„¶ååœ¨ groupB å†…é€‰ vruntime æœ€å°çš„ P1                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   è¿è¡Œå vruntime æ›´æ–°ï¼š                                        â”‚
â”‚   â”œâ”€â”€ P1 çš„ vruntime å¢åŠ                                        â”‚
â”‚   â””â”€â”€ groupB çš„ se.vruntime ä¹Ÿç›¸åº”å¢åŠ                           â”‚
â”‚       ï¼ˆå¢åŠ é‡ä¸ groupB çš„ weight æˆåæ¯”ï¼‰                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æƒé‡åˆ†é… CPU æ ¸æ•°çš„åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æƒé‡å¦‚ä½•"åˆ†é…"CPU æ ¸æ•°                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   åœºæ™¯ï¼š4 æ ¸ CPUï¼ŒgroupA(weight=100) å’Œ groupB(weight=300)      â”‚
â”‚         ä¸¤ä¸ªç»„éƒ½æœ‰è¶³å¤Ÿå¤šçš„è¿›ç¨‹ï¼ŒCPU ç«äº‰æ¿€çƒˆ                    â”‚
â”‚                                                                 â”‚
â”‚   é•¿æœŸæ¥çœ‹ï¼š                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   groupA çš„ vruntime å¢é•¿é€Ÿåº¦ = å®é™…æ—¶é—´ Ã— (1024/100)    â”‚  â”‚
â”‚   â”‚                              = å®é™…æ—¶é—´ Ã— 10.24          â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   groupB çš„ vruntime å¢é•¿é€Ÿåº¦ = å®é™…æ—¶é—´ Ã— (1024/300)    â”‚  â”‚
â”‚   â”‚                              = å®é™…æ—¶é—´ Ã— 3.41           â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   ä¸ºäº†ä¿æŒ vruntime å¹³è¡¡ï¼ˆå…¬å¹³è°ƒåº¦ï¼‰ï¼š                    â”‚  â”‚
â”‚   â”‚   groupA å®é™…è¿è¡Œæ—¶é—´ : groupB å®é™…è¿è¡Œæ—¶é—´ = 1 : 3      â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   4 æ ¸ CPU æ€»æ—¶é—´æŒ‰ 1:3 åˆ†é…ï¼š                           â”‚  â”‚
â”‚   â”‚   groupA â‰ˆ 1 æ ¸çš„è®¡ç®—èƒ½åŠ›                                â”‚  â”‚
â”‚   â”‚   groupB â‰ˆ 3 æ ¸çš„è®¡ç®—èƒ½åŠ›                                â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   è¿™å°±æ˜¯é€šè¿‡ weight æ§åˆ¶å®¹å™¨"åˆ†åˆ°å‡ æ ¸"çš„åŸç†ï¼                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è®¾ç½®æƒé‡çš„æ–¹æ³•

```bash
# Cgroup v1
echo 2048 > /sys/fs/cgroup/cpu/mygroup/cpu.shares
# é»˜è®¤ 1024ï¼Œè®¾ç½® 2048 è¡¨ç¤ºè·å¾— 2 å€çš„ CPU æ—¶é—´

# Cgroup v2
echo 200 > /sys/fs/cgroup/mygroup/cpu.weight
# é»˜è®¤ 100ï¼Œè®¾ç½® 200 è¡¨ç¤ºè·å¾— 2 å€çš„ CPU æ—¶é—´

# Docker
docker run --cpu-shares=2048 ...   # v1
docker run --cpu-weight=200 ...    # v2ï¼ˆè¾ƒæ–°ç‰ˆæœ¬ï¼‰
```

#### æƒé‡ vs é…é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æƒé‡ vs é…é¢                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   æƒé‡ï¼ˆcpu.shares / cpu.weightï¼‰ï¼š                             â”‚
â”‚   â”œâ”€â”€ è½¯é™åˆ¶ï¼Œç›¸å¯¹å€¼                                            â”‚
â”‚   â”œâ”€â”€ åªåœ¨ CPU ç«äº‰æ—¶ç”Ÿæ•ˆ                                       â”‚
â”‚   â”œâ”€â”€ ç©ºé—²æ—¶å¯ä»¥è¶…é¢ä½¿ç”¨                                        â”‚
â”‚   â””â”€â”€ é€‚åˆï¼šä¿è¯æœ€ä½ CPU ä»½é¢                                   â”‚
â”‚                                                                 â”‚
â”‚   é…é¢ï¼ˆcpu.cfs_quota_us / cpu.maxï¼‰ï¼š                          â”‚
â”‚   â”œâ”€â”€ ç¡¬é™åˆ¶ï¼Œç»å¯¹å€¼                                            â”‚
â”‚   â”œâ”€â”€ æ— è®ºæ˜¯å¦ç«äº‰éƒ½ç”Ÿæ•ˆ                                        â”‚
â”‚   â”œâ”€â”€ è¾¾åˆ°é…é¢å°±è¢«é™æµ                                          â”‚
â”‚   â””â”€â”€ é€‚åˆï¼šä¸¥æ ¼é™åˆ¶ CPU ä½¿ç”¨ä¸Šé™                               â”‚
â”‚                                                                 â”‚
â”‚   å®é™…ä½¿ç”¨ä¸­é€šå¸¸ç»“åˆä¸¤è€…ï¼š                                      â”‚
â”‚   â”œâ”€â”€ æƒé‡ä¿è¯æœ€ä½ä»½é¢                                          â”‚
â”‚   â””â”€â”€ é…é¢é™åˆ¶æœ€é«˜ä½¿ç”¨                                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.10 CPU é…é¢ï¼ˆQuotaï¼‰é™åˆ¶çš„å®ç°

CPU é…é¢æ˜¯**ç¡¬é™åˆ¶**ï¼Œé€šè¿‡ CFS å¸¦å®½æ§åˆ¶ï¼ˆCFS Bandwidth Controlï¼‰å®ç°ã€‚

#### é…é¢çš„æ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CPU é…é¢ï¼ˆQuotaï¼‰                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Cgroup v1:                                                    â”‚
â”‚   â”œâ”€â”€ cpu.cfs_period_usï¼šè°ƒåº¦å‘¨æœŸï¼ˆé»˜è®¤ 100000 = 100msï¼‰        â”‚
â”‚   â””â”€â”€ cpu.cfs_quota_usï¼šå‘¨æœŸå†…å¯ç”¨çš„ CPU æ—¶é—´ï¼ˆå¾®ç§’ï¼‰           â”‚
â”‚                                                                 â”‚
â”‚   Cgroup v2:                                                    â”‚
â”‚   â””â”€â”€ cpu.maxï¼š"quota period" æ ¼å¼ï¼ˆå¦‚ "50000 100000"ï¼‰         â”‚
â”‚                                                                 â”‚
â”‚   è®¡ç®—å…¬å¼ï¼š                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   å¯ç”¨ CPU æ ¸æ•° = quota / period                         â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   ç¤ºä¾‹ï¼š                                                 â”‚  â”‚
â”‚   â”‚   quota = 50000, period = 100000                         â”‚  â”‚
â”‚   â”‚   â†’ 50000/100000 = 0.5 æ ¸                                â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   quota = 200000, period = 100000                        â”‚  â”‚
â”‚   â”‚   â†’ 200000/100000 = 2 æ ¸                                 â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### CFS å¸¦å®½æ§åˆ¶çš„æ•°æ®ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cfs_bandwidth ç»“æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   struct cfs_bandwidth {                                        â”‚
â”‚       ktime_t period;           // è°ƒåº¦å‘¨æœŸï¼ˆå¦‚ 100msï¼‰         â”‚
â”‚       u64 quota;                // å‘¨æœŸå†…çš„é…é¢ï¼ˆå¾®ç§’ï¼‰         â”‚
â”‚       u64 runtime;              // å½“å‰å‘¨æœŸå‰©ä½™çš„å¯ç”¨æ—¶é—´       â”‚
â”‚       s64 hierarchical_quota;   // å±‚çº§é…é¢ï¼ˆè€ƒè™‘çˆ¶ cgroupï¼‰    â”‚
â”‚                                                                 â”‚
â”‚       struct hrtimer period_timer;   // å‘¨æœŸå®šæ—¶å™¨              â”‚
â”‚       struct hrtimer slack_timer;    // æ¾å¼›å®šæ—¶å™¨              â”‚
â”‚                                                                 â”‚
â”‚       int nr_throttled;         // è¢«é™æµçš„ cfs_rq æ•°é‡         â”‚
â”‚       u64 throttled_time;       // ç´¯è®¡è¢«é™æµçš„æ—¶é—´             â”‚
â”‚       ...                                                       â”‚
â”‚   };                                                            â”‚
â”‚                                                                 â”‚
â”‚   task_group ä¸­åŒ…å« cfs_bandwidthï¼š                             â”‚
â”‚   struct task_group {                                           â”‚
â”‚       ...                                                       â”‚
â”‚       struct cfs_bandwidth cfs_bandwidth;                       â”‚
â”‚       ...                                                       â”‚
â”‚   };                                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é…é¢é™åˆ¶çš„å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é…é¢é™åˆ¶å·¥ä½œæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   1. å‘¨æœŸå¼€å§‹                                                   â”‚
â”‚      â””â”€â”€ period_timer è§¦å‘ï¼Œé‡ç½® runtime = quota                â”‚
â”‚                                                                 â”‚
â”‚   2. è¿›ç¨‹è¿è¡Œï¼Œæ¶ˆè€—é…é¢                                         â”‚
â”‚      â””â”€â”€ æ¯æ¬¡è°ƒåº¦æ—¶ä» runtime ä¸­æ‰£é™¤è¿è¡Œæ—¶é—´                    â”‚
â”‚                                                                 â”‚
â”‚   3. é…é¢è€—å°½ï¼ˆruntime <= 0ï¼‰                                   â”‚
â”‚      â””â”€â”€ è¯¥ cgroup çš„æ‰€æœ‰è¿›ç¨‹è¢«é™æµï¼ˆthrottleï¼‰                 â”‚
â”‚          ä»è¿è¡Œé˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œæ— æ³•è¢«è°ƒåº¦                           â”‚
â”‚                                                                 â”‚
â”‚   4. ä¸‹ä¸€ä¸ªå‘¨æœŸå¼€å§‹                                             â”‚
â”‚      â””â”€â”€ runtime é‡ç½®ï¼Œè¢«é™æµçš„è¿›ç¨‹æ¢å¤ï¼ˆunthrottleï¼‰           â”‚
â”‚                                                                 â”‚
â”‚   æ—¶é—´çº¿ç¤ºä¾‹ï¼ˆquota=50ms, period=100msï¼‰ï¼š                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   0ms        50ms                    100ms      150ms    â”‚  â”‚
â”‚   â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚  â”‚
â”‚   â”‚   â”‚  è¿è¡Œ    â”‚      è¢«é™æµï¼ˆthrottleï¼‰ â”‚  è¿è¡Œ    â”‚      â”‚  â”‚
â”‚   â”‚   â”‚ æ¶ˆè€—é…é¢ â”‚      æ— æ³•è°ƒåº¦           â”‚ é…é¢é‡ç½® â”‚      â”‚  â”‚
â”‚   â”‚   â”‚          â”‚                         â”‚          â”‚      â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚   â”‚      å‘¨æœŸ 1                              å‘¨æœŸ 2           â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å†…æ ¸å®ç°ä»£ç 

```c
// kernel/sched/fair.c

// æ£€æŸ¥æ˜¯å¦éœ€è¦é™æµ
static bool check_cfs_rq_runtime(struct cfs_rq *cfs_rq)
{
    // å¦‚æœæ²¡æœ‰é…ç½®é…é¢ï¼Œä¸é™æµ
    if (!cfs_bandwidth_used())
        return false;
    
    // å¦‚æœè¿˜æœ‰å‰©ä½™é…é¢ï¼Œä¸é™æµ
    if (cfs_rq->runtime_remaining > 0)
        return false;
    
    // å°è¯•ä»å…¨å±€æ± ä¸­è·å–æ›´å¤šé…é¢
    if (assign_cfs_rq_runtime(cfs_rq))
        return false;
    
    // é…é¢è€—å°½ï¼Œéœ€è¦é™æµ
    return true;
}

// é™æµæ“ä½œ
static void throttle_cfs_rq(struct cfs_rq *cfs_rq)
{
    struct rq *rq = rq_of(cfs_rq);
    struct task_group *tg = cfs_rq->tg;
    
    // ä»è¿è¡Œé˜Ÿåˆ—ä¸­ç§»é™¤è¯¥ç»„çš„è°ƒåº¦å®ä½“
    dequeue_entity(cfs_rq_of(se), se, DEQUEUE_SLEEP);
    
    // æ ‡è®°ä¸ºè¢«é™æµçŠ¶æ€
    cfs_rq->throttled = 1;
    cfs_rq->throttled_clock = rq_clock(rq);
    
    // æ›´æ–°ç»Ÿè®¡
    tg->cfs_bandwidth.nr_throttled++;
}

// å‘¨æœŸå®šæ—¶å™¨å›è°ƒï¼Œé‡ç½®é…é¢
static enum hrtimer_restart sched_cfs_period_timer(struct hrtimer *timer)
{
    struct cfs_bandwidth *cfs_b = container_of(timer, 
                                               struct cfs_bandwidth, 
                                               period_timer);
    
    // é‡ç½®é…é¢
    cfs_b->runtime = cfs_b->quota;
    
    // è§£é™¤è¢«é™æµçš„ cfs_rq
    distribute_cfs_runtime(cfs_b);
    
    // é‡æ–°å¯åŠ¨å®šæ—¶å™¨
    hrtimer_forward_now(timer, cfs_b->period);
    return HRTIMER_RESTART;
}

// è§£é™¤é™æµ
static void unthrottle_cfs_rq(struct cfs_rq *cfs_rq)
{
    struct sched_entity *se = cfs_rq->tg->se[cpu_of(rq)];
    
    // æ¸…é™¤é™æµæ ‡è®°
    cfs_rq->throttled = 0;
    
    // é‡æ–°åŠ å…¥è¿è¡Œé˜Ÿåˆ—
    enqueue_entity(cfs_rq_of(se), se, ENQUEUE_WAKEUP);
    
    // æ›´æ–°ç»Ÿè®¡
    cfs_rq->throttled_clock_task_time += ...;
}
```

#### å¤š CPU çš„é…é¢åˆ†é…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤š CPU é…é¢åˆ†é…                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   é—®é¢˜ï¼šé…é¢æ˜¯å…¨å±€çš„ï¼Œä½†æ¯ä¸ª CPU æœ‰ç‹¬ç«‹çš„ cfs_rq                â”‚
â”‚                                                                 â”‚
â”‚   è§£å†³æ–¹æ¡ˆï¼šé…é¢æ±  + æŒ‰éœ€åˆ†é…                                   â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚              cfs_bandwidthï¼ˆå…¨å±€é…é¢æ± ï¼‰                 â”‚  â”‚
â”‚   â”‚              runtime = 200msï¼ˆ2 æ ¸é…é¢ï¼‰                 â”‚  â”‚
â”‚   â”‚                         â”‚                                â”‚  â”‚
â”‚   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
â”‚   â”‚         â†“               â†“               â†“               â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚   â”‚   â”‚ CPU 0    â”‚   â”‚ CPU 1    â”‚   â”‚ CPU 2    â”‚           â”‚  â”‚
â”‚   â”‚   â”‚ cfs_rq   â”‚   â”‚ cfs_rq   â”‚   â”‚ cfs_rq   â”‚           â”‚  â”‚
â”‚   â”‚   â”‚          â”‚   â”‚          â”‚   â”‚          â”‚           â”‚  â”‚
â”‚   â”‚   â”‚ local    â”‚   â”‚ local    â”‚   â”‚ local    â”‚           â”‚  â”‚
â”‚   â”‚   â”‚ runtime  â”‚   â”‚ runtime  â”‚   â”‚ runtime  â”‚           â”‚  â”‚
â”‚   â”‚   â”‚ = 50ms   â”‚   â”‚ = 80ms   â”‚   â”‚ = 70ms   â”‚           â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   æ¯ä¸ª CPU çš„ cfs_rq ä»å…¨å±€æ± ä¸­è·å–é…é¢                  â”‚  â”‚
â”‚   â”‚   ç”¨å®Œåå†ç”³è¯·ï¼Œç›´åˆ°å…¨å±€æ± è€—å°½                           â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   è¿™æ ·å¯ä»¥çµæ´»åˆ†é…ï¼š                                            â”‚
â”‚   â”œâ”€â”€ å¦‚æœåªæœ‰ CPU 0 ä¸Šæœ‰è¿›ç¨‹ï¼Œå®ƒå¯ä»¥ç”¨å®Œå…¨éƒ¨ 200ms            â”‚
â”‚   â””â”€â”€ å¦‚æœå¤šä¸ª CPU éƒ½æœ‰è¿›ç¨‹ï¼ŒæŒ‰éœ€åˆ†é…                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é™æµçš„å½±å“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é™æµçš„å½±å“                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   è¢«é™æµæ—¶ï¼š                                                    â”‚
â”‚   â”œâ”€â”€ è¿›ç¨‹æ— æ³•è·å¾— CPU æ—¶é—´                                     â”‚
â”‚   â”œâ”€â”€ å“åº”å»¶è¿Ÿå¢åŠ                                               â”‚
â”‚   â””â”€â”€ å¯èƒ½å¯¼è‡´åº”ç”¨å¡é¡¿                                          â”‚
â”‚                                                                 â”‚
â”‚   æŸ¥çœ‹é™æµç»Ÿè®¡ï¼š                                                â”‚
â”‚   $ cat /sys/fs/cgroup/mygroup/cpu.stat                         â”‚
â”‚   usage_usec 123456789        # ç´¯è®¡ä½¿ç”¨çš„ CPU æ—¶é—´             â”‚
â”‚   user_usec 100000000         # ç”¨æˆ·æ€æ—¶é—´                      â”‚
â”‚   system_usec 23456789        # å†…æ ¸æ€æ—¶é—´                      â”‚
â”‚   nr_periods 1000             # ç»å†çš„å‘¨æœŸæ•°                    â”‚
â”‚   nr_throttled 50             # è¢«é™æµçš„æ¬¡æ•°                    â”‚
â”‚   throttled_usec 5000000      # ç´¯è®¡è¢«é™æµçš„æ—¶é—´ï¼ˆ5ç§’ï¼‰         â”‚
â”‚                                                                 â”‚
â”‚   å¦‚æœ nr_throttled å¾ˆé«˜ï¼Œè¯´æ˜é…é¢è®¾ç½®è¿‡ä½                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.11 é…é¢å†™å…¥ cfs_bandwidth çš„å®ç°

å½“ç”¨æˆ·è®¾ç½® CPU é…é¢æ—¶ï¼Œå†…æ ¸å¦‚ä½•å°†å€¼å†™å…¥ `cfs_bandwidth` ç»“æ„ï¼Ÿv1 å’Œ v2 çš„å®ç°æœ‰æ‰€ä¸åŒã€‚

#### Cgroup v1 çš„å†™å…¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cgroup v1 é…é¢è®¾ç½®                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   v1 ä¸­é…é¢å’Œå‘¨æœŸæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼š                             â”‚
â”‚                                                                 â”‚
â”‚   # è®¾ç½®å‘¨æœŸï¼ˆ100msï¼‰                                           â”‚
â”‚   echo 100000 > /sys/fs/cgroup/cpu/mygroup/cpu.cfs_period_us    â”‚
â”‚                                                                 â”‚
â”‚   # è®¾ç½®é…é¢ï¼ˆ50msï¼Œå³ 0.5 æ ¸ï¼‰                                 â”‚
â”‚   echo 50000 > /sys/fs/cgroup/cpu/mygroup/cpu.cfs_quota_us      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```c
// kernel/sched/core.c (Cgroup v1)

// å†™å…¥ cpu.cfs_quota_us
static int cpu_cfs_quota_write_s64(struct cgroup_subsys_state *css,
                                    struct cftype *cftype, s64 quota_us)
{
    struct task_group *tg = css_tg(css);
    
    // è°ƒç”¨ tg_set_cfs_quota() è®¾ç½®é…é¢
    return tg_set_cfs_quota(tg, quota_us);
}

// å†™å…¥ cpu.cfs_period_us
static int cpu_cfs_period_write_u64(struct cgroup_subsys_state *css,
                                     struct cftype *cftype, u64 period_us)
{
    struct task_group *tg = css_tg(css);
    
    // è°ƒç”¨ tg_set_cfs_period() è®¾ç½®å‘¨æœŸ
    return tg_set_cfs_period(tg, period_us);
}

// å®é™…è®¾ç½®é…é¢çš„å‡½æ•°
int tg_set_cfs_quota(struct task_group *tg, long quota_us)
{
    u64 quota, period;
    
    // è·å–å½“å‰å‘¨æœŸ
    period = ktime_to_ns(tg->cfs_bandwidth.period);
    
    // è½¬æ¢é…é¢å•ä½ï¼ˆå¾®ç§’ â†’ çº³ç§’ï¼‰
    if (quota_us < 0)
        quota = RUNTIME_INF;  // -1 è¡¨ç¤ºä¸é™åˆ¶
    else
        quota = (u64)quota_us * NSEC_PER_USEC;
    
    // å†™å…¥ cfs_bandwidth
    return tg_set_cfs_bandwidth(tg, period, quota);
}

// æ ¸å¿ƒå‡½æ•°ï¼šè®¾ç½®å¸¦å®½å‚æ•°
static int tg_set_cfs_bandwidth(struct task_group *tg, u64 period, u64 quota)
{
    struct cfs_bandwidth *cfs_b = &tg->cfs_bandwidth;
    
    // åŠ é”ä¿æŠ¤
    raw_spin_lock_irq(&cfs_b->lock);
    
    // å†™å…¥å‘¨æœŸå’Œé…é¢
    cfs_b->period = ns_to_ktime(period);
    cfs_b->quota = quota;
    
    // é‡ç½®å½“å‰è¿è¡Œæ—¶é—´
    cfs_b->runtime = quota;
    
    // å¦‚æœé…é¢æœ‰æ•ˆï¼Œå¯åŠ¨å‘¨æœŸå®šæ—¶å™¨
    if (quota != RUNTIME_INF) {
        start_cfs_bandwidth(cfs_b);
    }
    
    raw_spin_unlock_irq(&cfs_b->lock);
    
    return 0;
}
```

#### Cgroup v2 çš„å†™å…¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cgroup v2 é…é¢è®¾ç½®                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   v2 ä¸­é…é¢å’Œå‘¨æœŸåˆå¹¶ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼š                               â”‚
â”‚                                                                 â”‚
â”‚   # è®¾ç½®é…é¢å’Œå‘¨æœŸï¼ˆ"quota period" æ ¼å¼ï¼‰                       â”‚
â”‚   echo "50000 100000" > /sys/fs/cgroup/mygroup/cpu.max          â”‚
â”‚                                                                 â”‚
â”‚   # æˆ–è€…åªè®¾ç½®é…é¢ï¼ˆä½¿ç”¨é»˜è®¤å‘¨æœŸ 100000ï¼‰                       â”‚
â”‚   echo "50000" > /sys/fs/cgroup/mygroup/cpu.max                 â”‚
â”‚                                                                 â”‚
â”‚   # å–æ¶ˆé™åˆ¶                                                    â”‚
â”‚   echo "max" > /sys/fs/cgroup/mygroup/cpu.max                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```c
// kernel/sched/core.c (Cgroup v2)

// cpu.max æ–‡ä»¶çš„å†™å…¥å¤„ç†
static ssize_t cpu_max_write(struct kernfs_open_file *of,
                              char *buf, size_t nbytes, loff_t off)
{
    struct task_group *tg = css_tg(of_css(of));
    u64 period = tg_get_cfs_period(tg);  // è·å–å½“å‰å‘¨æœŸ
    u64 quota;
    
    // è§£æè¾“å…¥
    // æ ¼å¼ï¼š"quota [period]" æˆ– "max [period]"
    if (sscanf(buf, "max %llu", &period) >= 0) {
        quota = RUNTIME_INF;  // "max" è¡¨ç¤ºä¸é™åˆ¶
    } else {
        // è§£æ "quota period" æˆ– "quota"
        int cnt = sscanf(buf, "%llu %llu", &quota, &period);
        if (cnt < 1)
            return -EINVAL;
        
        // è½¬æ¢å•ä½ï¼ˆå¾®ç§’ â†’ çº³ç§’ï¼‰
        quota *= NSEC_PER_USEC;
        if (cnt == 2)
            period *= NSEC_PER_USEC;
    }
    
    // è°ƒç”¨æ ¸å¿ƒå‡½æ•°è®¾ç½®å¸¦å®½
    return tg_set_cfs_bandwidth(tg, period, quota);
}

// è¯»å– cpu.max
static int cpu_max_show(struct seq_file *sf, void *v)
{
    struct task_group *tg = css_tg(seq_css(sf));
    struct cfs_bandwidth *cfs_b = &tg->cfs_bandwidth;
    u64 quota, period;
    
    // è¯»å–å½“å‰å€¼
    quota = cfs_b->quota;
    period = ktime_to_ns(cfs_b->period);
    
    // è¾“å‡ºæ ¼å¼
    if (quota == RUNTIME_INF)
        seq_printf(sf, "max %llu\n", period / NSEC_PER_USEC);
    else
        seq_printf(sf, "%llu %llu\n", 
                   quota / NSEC_PER_USEC, 
                   period / NSEC_PER_USEC);
    
    return 0;
}
```

#### v1 vs v2 å†™å…¥æµç¨‹å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    v1 vs v2 å†™å…¥æµç¨‹å¯¹æ¯”                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Cgroup v1:                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   ç”¨æˆ·ç©ºé—´                                               â”‚  â”‚
â”‚   â”‚   echo 100000 > cpu.cfs_period_us                        â”‚  â”‚
â”‚   â”‚   echo 50000 > cpu.cfs_quota_us                          â”‚  â”‚
â”‚   â”‚         â”‚              â”‚                                 â”‚  â”‚
â”‚   â”‚         â†“              â†“                                 â”‚  â”‚
â”‚   â”‚   å†…æ ¸ç©ºé—´                                               â”‚  â”‚
â”‚   â”‚   cpu_cfs_period_write_u64()                             â”‚  â”‚
â”‚   â”‚         â”‚              cpu_cfs_quota_write_s64()         â”‚  â”‚
â”‚   â”‚         â”‚                    â”‚                           â”‚  â”‚
â”‚   â”‚         â†“                    â†“                           â”‚  â”‚
â”‚   â”‚   tg_set_cfs_period()  tg_set_cfs_quota()                â”‚  â”‚
â”‚   â”‚         â”‚                    â”‚                           â”‚  â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚  â”‚
â”‚   â”‚                  â†“                                       â”‚  â”‚
â”‚   â”‚         tg_set_cfs_bandwidth(tg, period, quota)          â”‚  â”‚
â”‚   â”‚                  â”‚                                       â”‚  â”‚
â”‚   â”‚                  â†“                                       â”‚  â”‚
â”‚   â”‚         cfs_bandwidth.period = period                    â”‚  â”‚
â”‚   â”‚         cfs_bandwidth.quota = quota                      â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   Cgroup v2:                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   ç”¨æˆ·ç©ºé—´                                               â”‚  â”‚
â”‚   â”‚   echo "50000 100000" > cpu.max                          â”‚  â”‚
â”‚   â”‚         â”‚                                                â”‚  â”‚
â”‚   â”‚         â†“                                                â”‚  â”‚
â”‚   â”‚   å†…æ ¸ç©ºé—´                                               â”‚  â”‚
â”‚   â”‚   cpu_max_write()                                        â”‚  â”‚
â”‚   â”‚         â”‚                                                â”‚  â”‚
â”‚   â”‚         â†“ è§£æ "quota period"                            â”‚  â”‚
â”‚   â”‚   sscanf(buf, "%llu %llu", &quota, &period)              â”‚  â”‚
â”‚   â”‚         â”‚                                                â”‚  â”‚
â”‚   â”‚         â†“                                                â”‚  â”‚
â”‚   â”‚   tg_set_cfs_bandwidth(tg, period, quota)                â”‚  â”‚
â”‚   â”‚         â”‚                                                â”‚  â”‚
â”‚   â”‚         â†“                                                â”‚  â”‚
â”‚   â”‚   cfs_bandwidth.period = period                          â”‚  â”‚
â”‚   â”‚   cfs_bandwidth.quota = quota                            â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   æœ€ç»ˆéƒ½è°ƒç”¨ tg_set_cfs_bandwidth() å†™å…¥ cfs_bandwidth          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å¯åŠ¨å‘¨æœŸå®šæ—¶å™¨

```c
// å¯åŠ¨ CFS å¸¦å®½æ§åˆ¶çš„å‘¨æœŸå®šæ—¶å™¨
static void start_cfs_bandwidth(struct cfs_bandwidth *cfs_b)
{
    // å¦‚æœå®šæ—¶å™¨å·²ç»åœ¨è¿è¡Œï¼Œä¸é‡å¤å¯åŠ¨
    if (cfs_b->period_active)
        return;
    
    cfs_b->period_active = 1;
    
    // å¯åŠ¨é«˜ç²¾åº¦å®šæ—¶å™¨
    // æ¯ä¸ªå‘¨æœŸè§¦å‘ä¸€æ¬¡ï¼Œé‡ç½®é…é¢
    hrtimer_start(&cfs_b->period_timer,
                  cfs_b->period,
                  HRTIMER_MODE_REL_PINNED);
}
```

#### å•ä½è½¬æ¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å•ä½è½¬æ¢                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·ç©ºé—´ä½¿ç”¨å¾®ç§’ï¼ˆusï¼‰ï¼Œå†…æ ¸ä½¿ç”¨çº³ç§’ï¼ˆnsï¼‰                    â”‚
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·è¾“å…¥ï¼š50000 usï¼ˆ50msï¼‰                                    â”‚
â”‚        â”‚                                                        â”‚
â”‚        â†“ Ã— NSEC_PER_USEC (1000)                                 â”‚
â”‚   å†…æ ¸å­˜å‚¨ï¼š50000000 ns                                         â”‚
â”‚                                                                 â”‚
â”‚   #define NSEC_PER_USEC  1000                                   â”‚
â”‚   #define NSEC_PER_MSEC  1000000                                â”‚
â”‚   #define NSEC_PER_SEC   1000000000                             â”‚
â”‚                                                                 â”‚
â”‚   quota = (u64)quota_us * NSEC_PER_USEC;                        â”‚
â”‚   period = (u64)period_us * NSEC_PER_USEC;                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.12 è¿è¡Œé˜Ÿåˆ—å¸¦å®½çš„æ›´æ–°ä¸ç”³è¯·

æ¯ä¸ª CPU çš„ `cfs_rq` æœ‰è‡ªå·±çš„æœ¬åœ°é…é¢ï¼ˆ`runtime_remaining`ï¼‰ï¼Œéœ€è¦ä»å…¨å±€ `cfs_bandwidth` ä¸­ç”³è¯·ã€‚

#### cfs_rq çš„æœ¬åœ°é…é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cfs_rq çš„æœ¬åœ°é…é¢                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   struct cfs_rq {                                               â”‚
â”‚       ...                                                       â”‚
â”‚       s64 runtime_remaining;    // æœ¬åœ°å‰©ä½™é…é¢                 â”‚
â”‚       int throttled;            // æ˜¯å¦è¢«é™æµ                   â”‚
â”‚       u64 throttled_clock;      // è¢«é™æµçš„æ—¶é—´ç‚¹               â”‚
â”‚       ...                                                       â”‚
â”‚   };                                                            â”‚
â”‚                                                                 â”‚
â”‚   æ¯ä¸ª CPU çš„ cfs_rq ç»´æŠ¤è‡ªå·±çš„ runtime_remaining               â”‚
â”‚   ç”¨å®Œåä»å…¨å±€ cfs_bandwidth.runtime ä¸­ç”³è¯·                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å¸¦å®½æ¶ˆè€—æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¸¦å®½æ¶ˆè€—æµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   è¿›ç¨‹è¿è¡Œæ—¶ï¼Œè°ƒåº¦å™¨ä¼šæ›´æ–°å¸¦å®½æ¶ˆè€—ï¼š                            â”‚
â”‚                                                                 â”‚
â”‚   1. è¿›ç¨‹è¿è¡Œä¸€æ®µæ—¶é—´ delta                                     â”‚
â”‚                                                                 â”‚
â”‚   2. è°ƒç”¨ account_cfs_rq_runtime() æ‰£é™¤æœ¬åœ°é…é¢                 â”‚
â”‚      cfs_rq->runtime_remaining -= delta                         â”‚
â”‚                                                                 â”‚
â”‚   3. å¦‚æœæœ¬åœ°é…é¢ä¸è¶³ï¼ˆruntime_remaining <= 0ï¼‰                 â”‚
â”‚      è°ƒç”¨ assign_cfs_rq_runtime() ä»å…¨å±€æ± ç”³è¯·                  â”‚
â”‚                                                                 â”‚
â”‚   4. å¦‚æœå…¨å±€æ± ä¹Ÿæ²¡æœ‰é…é¢äº†                                     â”‚
â”‚      è°ƒç”¨ throttle_cfs_rq() é™æµ                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å†…æ ¸å®ç°ï¼šå¸¦å®½æ¶ˆè€—

```c
// kernel/sched/fair.c

// æ¯æ¬¡è°ƒåº¦æ—¶æ›´æ–°å¸¦å®½æ¶ˆè€—
static void account_cfs_rq_runtime(struct cfs_rq *cfs_rq, u64 delta_exec)
{
    // å¦‚æœæ²¡æœ‰é…ç½®å¸¦å®½é™åˆ¶ï¼Œç›´æ¥è¿”å›
    if (!cfs_bandwidth_used())
        return;
    
    // æ‰£é™¤æœ¬åœ°é…é¢
    cfs_rq->runtime_remaining -= delta_exec;
    
    // å¦‚æœæœ¬åœ°é…é¢è¿˜å¤Ÿï¼Œç»§ç»­è¿è¡Œ
    if (likely(cfs_rq->runtime_remaining > 0))
        return;
    
    // æœ¬åœ°é…é¢ä¸è¶³ï¼Œå°è¯•ä»å…¨å±€æ± ç”³è¯·
    // æˆ–è€…è§¦å‘é™æµ
    if (cfs_rq->runtime_remaining < 0)
        throttle_cfs_rq(cfs_rq);
}
```

#### å†…æ ¸å®ç°ï¼šç”³è¯·é…é¢

```c
// kernel/sched/fair.c

// ä»å…¨å±€æ± ç”³è¯·é…é¢åˆ°æœ¬åœ°
static int assign_cfs_rq_runtime(struct cfs_rq *cfs_rq)
{
    struct task_group *tg = cfs_rq->tg;
    struct cfs_bandwidth *cfs_b = &tg->cfs_bandwidth;
    u64 amount = 0, min_amount;
    
    // æ¯æ¬¡ç”³è¯·çš„æœ€å°é‡ï¼ˆé»˜è®¤ 5msï¼‰
    min_amount = sched_cfs_bandwidth_slice();
    
    raw_spin_lock(&cfs_b->lock);
    
    // æ£€æŸ¥å…¨å±€æ± æ˜¯å¦æœ‰å‰©ä½™é…é¢
    if (cfs_b->quota == RUNTIME_INF) {
        // æ— é™åˆ¶ï¼Œç›´æ¥ç»™
        amount = min_amount;
    } else if (cfs_b->runtime > 0) {
        // ä»å…¨å±€æ± ä¸­å–å‡ºé…é¢
        amount = min(cfs_b->runtime, min_amount);
        cfs_b->runtime -= amount;
    }
    
    raw_spin_unlock(&cfs_b->lock);
    
    // å¢åŠ æœ¬åœ°é…é¢
    cfs_rq->runtime_remaining += amount;
    
    // è¿”å›æ˜¯å¦æˆåŠŸè·å–é…é¢
    return cfs_rq->runtime_remaining > 0;
}

// é»˜è®¤æ¯æ¬¡ç”³è¯· 5ms çš„é…é¢
static u64 sched_cfs_bandwidth_slice(void)
{
    return (u64)sysctl_sched_cfs_bandwidth_slice * NSEC_PER_USEC;
}
// sysctl_sched_cfs_bandwidth_slice é»˜è®¤å€¼ä¸º 5000ï¼ˆ5msï¼‰
```

#### å¸¦å®½ç”³è¯·çš„æ—¶æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¸¦å®½ç”³è¯·æ—¶æœº                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   1. è¿›ç¨‹è¿è¡Œæ¶ˆè€—å®Œæœ¬åœ°é…é¢æ—¶                                   â”‚
â”‚      â””â”€â”€ account_cfs_rq_runtime() æ£€æµ‹åˆ° runtime_remaining <= 0â”‚
â”‚                                                                 â”‚
â”‚   2. è¿›ç¨‹è¢«å”¤é†’åŠ å…¥é˜Ÿåˆ—æ—¶                                       â”‚
â”‚      â””â”€â”€ enqueue_entity() ä¸­æ£€æŸ¥æ˜¯å¦éœ€è¦ç”³è¯·é…é¢                â”‚
â”‚                                                                 â”‚
â”‚   3. è¢«é™æµåå‘¨æœŸå®šæ—¶å™¨è§¦å‘æ—¶                                   â”‚
â”‚      â””â”€â”€ distribute_cfs_runtime() åˆ†é…æ–°é…é¢                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é™æµä¸è§£é™¤é™æµ

```c
// kernel/sched/fair.c

// é™æµï¼šé…é¢è€—å°½æ—¶è°ƒç”¨
static void throttle_cfs_rq(struct cfs_rq *cfs_rq)
{
    struct rq *rq = rq_of(cfs_rq);
    struct cfs_bandwidth *cfs_b = tg_cfs_bandwidth(cfs_rq->tg);
    struct sched_entity *se;
    
    // æ ‡è®°ä¸ºé™æµçŠ¶æ€
    cfs_rq->throttled = 1;
    cfs_rq->throttled_clock = rq_clock(rq);
    
    // ä»è°ƒåº¦æ ‘ä¸­ç§»é™¤è¯¥ç»„çš„è°ƒåº¦å®ä½“
    se = cfs_rq->tg->se[cpu_of(rq)];
    if (se) {
        dequeue_entity(cfs_rq_of(se), se, DEQUEUE_SLEEP);
    }
    
    // æ›´æ–°ç»Ÿè®¡
    cfs_b->nr_throttled++;
    
    // å°† cfs_rq åŠ å…¥é™æµåˆ—è¡¨ï¼Œç­‰å¾…è§£é™¤
    list_add_tail(&cfs_rq->throttled_list, &cfs_b->throttled_cfs_rq);
}

// è§£é™¤é™æµï¼šå‘¨æœŸå®šæ—¶å™¨è§¦å‘æ—¶è°ƒç”¨
static void unthrottle_cfs_rq(struct cfs_rq *cfs_rq)
{
    struct rq *rq = rq_of(cfs_rq);
    struct sched_entity *se;
    
    // æ¸…é™¤é™æµæ ‡è®°
    cfs_rq->throttled = 0;
    
    // ä»é™æµåˆ—è¡¨ä¸­ç§»é™¤
    list_del_init(&cfs_rq->throttled_list);
    
    // é‡æ–°åŠ å…¥è°ƒåº¦æ ‘
    se = cfs_rq->tg->se[cpu_of(rq)];
    if (se) {
        enqueue_entity(cfs_rq_of(se), se, ENQUEUE_WAKEUP);
    }
    
    // è§¦å‘é‡æ–°è°ƒåº¦
    resched_curr(rq);
}
```

#### å‘¨æœŸå®šæ—¶å™¨ï¼šåˆ†é…æ–°é…é¢

```c
// kernel/sched/fair.c

// å‘¨æœŸå®šæ—¶å™¨å›è°ƒ
static enum hrtimer_restart sched_cfs_period_timer(struct hrtimer *timer)
{
    struct cfs_bandwidth *cfs_b = container_of(timer,
                                               struct cfs_bandwidth,
                                               period_timer);
    int overrun;
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å‘¨æœŸè¢«è·³è¿‡
    overrun = hrtimer_forward_now(timer, cfs_b->period);
    
    // é‡ç½®å…¨å±€é…é¢
    cfs_b->runtime = cfs_b->quota;
    
    // åˆ†é…é…é¢ç»™è¢«é™æµçš„ cfs_rq
    distribute_cfs_runtime(cfs_b);
    
    return HRTIMER_RESTART;
}

// åˆ†é…é…é¢ç»™è¢«é™æµçš„è¿è¡Œé˜Ÿåˆ—
static void distribute_cfs_runtime(struct cfs_bandwidth *cfs_b)
{
    struct cfs_rq *cfs_rq;
    u64 runtime, remaining = cfs_b->runtime;
    
    // éå†æ‰€æœ‰è¢«é™æµçš„ cfs_rq
    list_for_each_entry(cfs_rq, &cfs_b->throttled_cfs_rq, throttled_list) {
        struct rq *rq = rq_of(cfs_rq);
        
        // è®¡ç®—è¦åˆ†é…çš„é…é¢
        runtime = min(remaining, sched_cfs_bandwidth_slice());
        remaining -= runtime;
        
        // åˆ†é…ç»™æœ¬åœ°
        cfs_rq->runtime_remaining += runtime;
        
        // å¦‚æœåˆ†é…äº†é…é¢ï¼Œè§£é™¤é™æµ
        if (cfs_rq->runtime_remaining > 0) {
            unthrottle_cfs_rq(cfs_rq);
        }
        
        // å¦‚æœå…¨å±€é…é¢ç”¨å®Œï¼Œåœæ­¢åˆ†é…
        if (remaining <= 0)
            break;
    }
    
    // æ›´æ–°å…¨å±€å‰©ä½™é…é¢
    cfs_b->runtime = remaining;
}
```

#### å®Œæ•´çš„å¸¦å®½æ§åˆ¶æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®Œæ•´çš„å¸¦å®½æ§åˆ¶æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   å‘¨æœŸå¼€å§‹                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ period_timer è§¦å‘                                        â”‚  â”‚
â”‚   â”‚     â”‚                                                    â”‚  â”‚
â”‚   â”‚     â†“                                                    â”‚  â”‚
â”‚   â”‚ cfs_b->runtime = cfs_b->quota  (é‡ç½®å…¨å±€é…é¢)            â”‚  â”‚
â”‚   â”‚     â”‚                                                    â”‚  â”‚
â”‚   â”‚     â†“                                                    â”‚  â”‚
â”‚   â”‚ distribute_cfs_runtime()  (åˆ†é…ç»™è¢«é™æµçš„ cfs_rq)        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                      â”‚
â”‚                          â†“                                      â”‚
â”‚   è¿›ç¨‹è¿è¡Œ                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ è¿›ç¨‹åœ¨ CPU ä¸Šè¿è¡Œ delta æ—¶é—´                             â”‚  â”‚
â”‚   â”‚     â”‚                                                    â”‚  â”‚
â”‚   â”‚     â†“                                                    â”‚  â”‚
â”‚   â”‚ account_cfs_rq_runtime(delta)                            â”‚  â”‚
â”‚   â”‚     â”‚                                                    â”‚  â”‚
â”‚   â”‚     â†“                                                    â”‚  â”‚
â”‚   â”‚ cfs_rq->runtime_remaining -= delta                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                      â”‚
â”‚                          â†“                                      â”‚
â”‚   æœ¬åœ°é…é¢ä¸è¶³                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ runtime_remaining <= 0                                   â”‚  â”‚
â”‚   â”‚     â”‚                                                    â”‚  â”‚
â”‚   â”‚     â†“                                                    â”‚  â”‚
â”‚   â”‚ assign_cfs_rq_runtime()  (ä»å…¨å±€æ± ç”³è¯·)                  â”‚  â”‚
â”‚   â”‚     â”‚                                                    â”‚  â”‚
â”‚   â”‚     â”œâ”€â”€ æˆåŠŸï¼šç»§ç»­è¿è¡Œ                                   â”‚  â”‚
â”‚   â”‚     â”‚                                                    â”‚  â”‚
â”‚   â”‚     â””â”€â”€ å¤±è´¥ï¼ˆå…¨å±€æ± ä¹Ÿç©ºäº†ï¼‰                             â”‚  â”‚
â”‚   â”‚              â”‚                                           â”‚  â”‚
â”‚   â”‚              â†“                                           â”‚  â”‚
â”‚   â”‚         throttle_cfs_rq()  (é™æµ)                        â”‚  â”‚
â”‚   â”‚              â”‚                                           â”‚  â”‚
â”‚   â”‚              â†“                                           â”‚  â”‚
â”‚   â”‚         ç­‰å¾…ä¸‹ä¸€ä¸ªå‘¨æœŸ...                                â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.13 period_timer ä¸ slack_timer

CFS å¸¦å®½æ§åˆ¶ä½¿ç”¨ä¸¤ä¸ªå®šæ—¶å™¨æ¥ç®¡ç†é…é¢åˆ†é…ï¼š`period_timer` å’Œ `slack_timer`ã€‚

#### ä¸¤ä¸ªå®šæ—¶å™¨çš„ä½œç”¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸¤ä¸ªå®šæ—¶å™¨çš„ä½œç”¨                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   struct cfs_bandwidth {                                        â”‚
â”‚       ...                                                       â”‚
â”‚       struct hrtimer period_timer;  // å‘¨æœŸå®šæ—¶å™¨               â”‚
â”‚       struct hrtimer slack_timer;   // æ¾å¼›å®šæ—¶å™¨               â”‚
â”‚       ...                                                       â”‚
â”‚   };                                                            â”‚
â”‚                                                                 â”‚
â”‚   period_timerï¼ˆå‘¨æœŸå®šæ—¶å™¨ï¼‰ï¼š                                  â”‚
â”‚   â”œâ”€â”€ æ¯ä¸ªå‘¨æœŸè§¦å‘ä¸€æ¬¡ï¼ˆå¦‚æ¯ 100msï¼‰                            â”‚
â”‚   â”œâ”€â”€ é‡ç½®å…¨å±€é…é¢ runtime = quota                              â”‚
â”‚   â””â”€â”€ è§£é™¤è¢«é™æµçš„ cfs_rq                                       â”‚
â”‚                                                                 â”‚
â”‚   slack_timerï¼ˆæ¾å¼›å®šæ—¶å™¨ï¼‰ï¼š                                   â”‚
â”‚   â”œâ”€â”€ ç”¨äºå›æ”¶æœªä½¿ç”¨å®Œçš„é…é¢                                    â”‚
â”‚   â”œâ”€â”€ å½“ cfs_rq å½’è¿˜é…é¢æ—¶å¯åŠ¨                                  â”‚
â”‚   â””â”€â”€ å»¶è¿Ÿä¸€å°æ®µæ—¶é—´åï¼Œå°†å›æ”¶çš„é…é¢åˆ†é…ç»™éœ€è¦çš„ cfs_rq         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### period_timer è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    period_timer å·¥ä½œæµç¨‹                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   æ—¶é—´çº¿ï¼ˆperiod = 100ms, quota = 50msï¼‰ï¼š                      â”‚
â”‚                                                                 â”‚
â”‚   0ms                    100ms                   200ms          â”‚
â”‚   â”‚                        â”‚                        â”‚           â”‚
â”‚   â”œâ”€â”€ period_timer è§¦å‘ â”€â”€â”œâ”€â”€ period_timer è§¦å‘ â”€â”€â”œâ”€â”€          â”‚
â”‚   â”‚   runtime = 50ms      â”‚   runtime = 50ms      â”‚            â”‚
â”‚   â”‚                        â”‚                        â”‚           â”‚
â”‚   â”‚   è¿›ç¨‹è¿è¡Œ...          â”‚   è¿›ç¨‹è¿è¡Œ...          â”‚           â”‚
â”‚   â”‚   æ¶ˆè€—é…é¢             â”‚   æ¶ˆè€—é…é¢             â”‚           â”‚
â”‚   â”‚                        â”‚                        â”‚           â”‚
â”‚   â”‚   50ms: é…é¢è€—å°½       â”‚   50ms: é…é¢è€—å°½       â”‚           â”‚
â”‚   â”‚   é™æµ...              â”‚   é™æµ...              â”‚           â”‚
â”‚   â”‚                        â”‚                        â”‚           â”‚
â”‚                                                                 â”‚
â”‚   period_timer çš„èŒè´£ï¼š                                         â”‚
â”‚   1. é‡ç½® cfs_b->runtime = cfs_b->quota                         â”‚
â”‚   2. è°ƒç”¨ distribute_cfs_runtime() åˆ†é…é…é¢                     â”‚
â”‚   3. è§£é™¤è¢«é™æµçš„ cfs_rq                                        â”‚
â”‚   4. é‡æ–°å¯åŠ¨å®šæ—¶å™¨ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªå‘¨æœŸ                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```c
// kernel/sched/fair.c

// period_timer å›è°ƒå‡½æ•°
static enum hrtimer_restart sched_cfs_period_timer(struct hrtimer *timer)
{
    struct cfs_bandwidth *cfs_b = container_of(timer,
                                               struct cfs_bandwidth,
                                               period_timer);
    int overrun;
    int idle = 0;
    
    raw_spin_lock(&cfs_b->lock);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å‘¨æœŸè¢«è·³è¿‡ï¼ˆç³»ç»Ÿç¹å¿™æ—¶å¯èƒ½å‘ç”Ÿï¼‰
    overrun = hrtimer_forward_now(timer, cfs_b->period);
    
    // å¦‚æœæ²¡æœ‰è¢«é™æµçš„ cfs_rqï¼Œä¸”æ²¡æœ‰æ´»è·ƒçš„è¿›ç¨‹ï¼Œå¯ä»¥åœæ­¢å®šæ—¶å™¨
    if (cfs_b->idle && !cfs_b->nr_throttled) {
        cfs_b->period_active = 0;
        idle = 1;
    }
    
    // é‡ç½®å…¨å±€é…é¢
    cfs_b->runtime = cfs_b->quota;
    
    raw_spin_unlock(&cfs_b->lock);
    
    // åˆ†é…é…é¢ç»™è¢«é™æµçš„ cfs_rq
    if (!idle)
        distribute_cfs_runtime(cfs_b);
    
    return idle ? HRTIMER_NORESTART : HRTIMER_RESTART;
}
```

#### slack_timer è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    slack_timer çš„ä½œç”¨                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   é—®é¢˜åœºæ™¯ï¼š                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   CPU 0 çš„ cfs_rqï¼šç”³è¯·äº† 10ms é…é¢ï¼Œåªç”¨äº† 3ms          â”‚  â”‚
â”‚   â”‚                    å‰©ä½™ 7ms æ²¡ç”¨å®Œ                        â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   CPU 1 çš„ cfs_rqï¼šé…é¢ç”¨å®Œäº†ï¼Œè¢«é™æµ                    â”‚  â”‚
â”‚   â”‚                    ä½†å…¨å±€æ± å·²ç»ç©ºäº†                       â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   é—®é¢˜ï¼šCPU 0 æœ‰å‰©ä½™é…é¢ï¼ŒCPU 1 å´åœ¨ç­‰å¾…                 â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   è§£å†³æ–¹æ¡ˆï¼šslack_timer                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   1. CPU 0 çš„è¿›ç¨‹ç¡çœ /é€€å‡ºï¼Œå½’è¿˜å‰©ä½™é…é¢åˆ°å…¨å±€æ±          â”‚  â”‚
â”‚   â”‚      cfs_b->runtime += 7ms                               â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   2. å¯åŠ¨ slack_timerï¼ˆå»¶è¿Ÿ 5msï¼‰                        â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   3. slack_timer è§¦å‘åï¼Œåˆ†é…é…é¢ç»™è¢«é™æµçš„ CPU 1        â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   ä¸ºä»€ä¹ˆè¦å»¶è¿Ÿï¼Ÿ                                                â”‚
â”‚   â”œâ”€â”€ é¿å…é¢‘ç¹è§¦å‘åˆ†é…æ“ä½œ                                      â”‚
â”‚   â”œâ”€â”€ ç­‰å¾…æ›´å¤šçš„é…é¢è¢«å½’è¿˜ï¼Œæ‰¹é‡å¤„ç†                            â”‚
â”‚   â””â”€â”€ å‡å°‘é”ç«äº‰å’Œ CPU é—´é€šä¿¡å¼€é”€                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```c
// kernel/sched/fair.c

// å½’è¿˜æœªä½¿ç”¨çš„é…é¢
static void return_cfs_rq_runtime(struct cfs_rq *cfs_rq)
{
    struct task_group *tg = cfs_rq->tg;
    struct cfs_bandwidth *cfs_b = &tg->cfs_bandwidth;
    s64 slack_runtime = cfs_rq->runtime_remaining;
    
    // å¦‚æœæ²¡æœ‰å‰©ä½™é…é¢ï¼Œä¸éœ€è¦å½’è¿˜
    if (slack_runtime <= 0)
        return;
    
    raw_spin_lock(&cfs_b->lock);
    
    // å½’è¿˜åˆ°å…¨å±€æ± 
    cfs_b->runtime += slack_runtime;
    
    // æ¸…ç©ºæœ¬åœ°é…é¢
    cfs_rq->runtime_remaining = 0;
    
    raw_spin_unlock(&cfs_b->lock);
    
    // å¯åŠ¨ slack_timerï¼Œå»¶è¿Ÿåˆ†é…ç»™å…¶ä»– cfs_rq
    start_cfs_slack_bandwidth(cfs_b);
}

// å¯åŠ¨ slack_timer
static void start_cfs_slack_bandwidth(struct cfs_bandwidth *cfs_b)
{
    // é»˜è®¤å»¶è¿Ÿ 5ms
    u64 slack_delay = 5 * NSEC_PER_MSEC;
    
    // å¦‚æœå®šæ—¶å™¨å·²ç»åœ¨è¿è¡Œï¼Œä¸é‡å¤å¯åŠ¨
    if (hrtimer_active(&cfs_b->slack_timer))
        return;
    
    // å¯åŠ¨å»¶è¿Ÿå®šæ—¶å™¨
    hrtimer_start(&cfs_b->slack_timer,
                  ns_to_ktime(slack_delay),
                  HRTIMER_MODE_REL);
}

// slack_timer å›è°ƒå‡½æ•°
static enum hrtimer_restart sched_cfs_slack_timer(struct hrtimer *timer)
{
    struct cfs_bandwidth *cfs_b = container_of(timer,
                                               struct cfs_bandwidth,
                                               slack_timer);
    
    // åˆ†é…å›æ”¶çš„é…é¢ç»™è¢«é™æµçš„ cfs_rq
    distribute_cfs_runtime(cfs_b);
    
    return HRTIMER_NORESTART;  // ä¸€æ¬¡æ€§å®šæ—¶å™¨
}
```

#### ä¸¤ä¸ªå®šæ—¶å™¨çš„åä½œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®šæ—¶å™¨åä½œæµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   æ—¶é—´çº¿ï¼š                                                      â”‚
â”‚                                                                 â”‚
â”‚   0ms        30ms    35ms        50ms              100ms        â”‚
â”‚   â”‚           â”‚       â”‚           â”‚                   â”‚         â”‚
â”‚   â”‚           â”‚       â”‚           â”‚                   â”‚         â”‚
â”‚   â”œâ”€ period_timer                                     â”œâ”€ period â”‚
â”‚   â”‚  runtime=50ms                                     â”‚  é‡ç½®   â”‚
â”‚   â”‚                                                   â”‚         â”‚
â”‚   â”‚  CPU0: ç”³è¯·10ms                                   â”‚         â”‚
â”‚   â”‚  CPU1: ç”³è¯·10ms                                   â”‚         â”‚
â”‚   â”‚                                                   â”‚         â”‚
â”‚   â”‚           â”‚                                       â”‚         â”‚
â”‚   â”‚           â”œâ”€ CPU0 è¿›ç¨‹ç¡çœ                         â”‚         â”‚
â”‚   â”‚           â”‚  å½’è¿˜ 7ms åˆ°å…¨å±€æ±                     â”‚         â”‚
â”‚   â”‚           â”‚  å¯åŠ¨ slack_timer                     â”‚         â”‚
â”‚   â”‚           â”‚                                       â”‚         â”‚
â”‚   â”‚           â”‚       â”‚                               â”‚         â”‚
â”‚   â”‚           â”‚       â”œâ”€ slack_timer è§¦å‘             â”‚         â”‚
â”‚   â”‚           â”‚       â”‚  åˆ†é…é…é¢ç»™è¢«é™æµçš„ cfs_rq    â”‚         â”‚
â”‚   â”‚           â”‚       â”‚                               â”‚         â”‚
â”‚   â”‚           â”‚       â”‚           â”‚                   â”‚         â”‚
â”‚   â”‚           â”‚       â”‚           â”œâ”€ CPU1 é…é¢è€—å°½    â”‚         â”‚
â”‚   â”‚           â”‚       â”‚           â”‚  è¢«é™æµ           â”‚         â”‚
â”‚   â”‚           â”‚       â”‚           â”‚                   â”‚         â”‚
â”‚   â”‚           â”‚       â”‚           â”‚                   â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â”‚   period_timerï¼šå‘¨æœŸæ€§é‡ç½®é…é¢ï¼ˆç¡¬æ€§ä¿è¯ï¼‰                      â”‚
â”‚   slack_timerï¼šåŠæ—¶å›æ”¶åˆ©ç”¨å‰©ä½™é…é¢ï¼ˆä¼˜åŒ–åˆ©ç”¨ç‡ï¼‰               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é…é¢å½’è¿˜çš„æ—¶æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é…é¢å½’è¿˜æ—¶æœº                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ä»€ä¹ˆæ—¶å€™ä¼šå½’è¿˜é…é¢ï¼Ÿ                                          â”‚
â”‚                                                                 â”‚
â”‚   1. è¿›ç¨‹ç¡çœ ï¼ˆdequeueï¼‰                                        â”‚
â”‚      â””â”€â”€ è¿›ç¨‹ä»è¿è¡Œé˜Ÿåˆ—ç§»é™¤æ—¶ï¼Œå½’è¿˜è¯¥ cfs_rq çš„å‰©ä½™é…é¢         â”‚
â”‚                                                                 â”‚
â”‚   2. è¿›ç¨‹é€€å‡º                                                   â”‚
â”‚      â””â”€â”€ è¿›ç¨‹ç»“æŸæ—¶ï¼Œå½’è¿˜é…é¢                                   â”‚
â”‚                                                                 â”‚
â”‚   3. è¿›ç¨‹è¿ç§»åˆ°å…¶ä»– CPU                                         â”‚
â”‚      â””â”€â”€ ä»å½“å‰ cfs_rq ç§»é™¤ï¼Œå½’è¿˜é…é¢                           â”‚
â”‚                                                                 â”‚
â”‚   4. cfs_rq å˜ç©º                                                â”‚
â”‚      â””â”€â”€ è¯¥ CPU ä¸Šæ²¡æœ‰è¯¥ç»„çš„è¿›ç¨‹äº†ï¼Œå½’è¿˜æ‰€æœ‰é…é¢                â”‚
â”‚                                                                 â”‚
â”‚   ä»£ç ä½ç½®ï¼š                                                    â”‚
â”‚   dequeue_entity() â†’ put_prev_entity() â†’ return_cfs_rq_runtime()â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.14 é…é¢ã€cfs_bandwidth ä¸å®¹å™¨çš„å…³ç³»

ç†è§£é…é¢çš„æœ¬è´¨ä»¥åŠå®ƒå¦‚ä½•å®ç°å®¹å™¨çš„èµ„æºæ§åˆ¶ã€‚

#### é…é¢çš„æœ¬è´¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é…é¢ï¼ˆQuotaï¼‰çš„æœ¬è´¨                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   é…é¢ = è¯¥ cgroup å†…æ‰€æœ‰è¿›ç¨‹å…±äº«çš„ CPU è¿è¡Œæ—¶é—´ä¸Šé™            â”‚
â”‚                                                                 â”‚
â”‚   ç¤ºä¾‹ï¼šgroupA é…é¢ = 50ms/100ms                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   groupA (quota=50ms)                                    â”‚  â”‚
â”‚   â”‚       â”‚                                                  â”‚  â”‚
â”‚   â”‚       â”œâ”€â”€ è¿›ç¨‹ A1                                        â”‚  â”‚
â”‚   â”‚       â”œâ”€â”€ è¿›ç¨‹ A2                                        â”‚  â”‚
â”‚   â”‚       â””â”€â”€ è¿›ç¨‹ A3                                        â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   è¿™ 3 ä¸ªè¿›ç¨‹å…±äº« 50ms çš„é…é¢ï¼š                          â”‚  â”‚
â”‚   â”‚   â”œâ”€â”€ A1 è·‘äº† 20ms                                       â”‚  â”‚
â”‚   â”‚   â”œâ”€â”€ A2 è·‘äº† 20ms                                       â”‚  â”‚
â”‚   â”‚   â”œâ”€â”€ A3 è·‘äº† 10ms                                       â”‚  â”‚
â”‚   â”‚   â””â”€â”€ é…é¢ç”¨å®Œï¼ä¸‰ä¸ªè¿›ç¨‹éƒ½è¢«é™æµ                         â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   æœ¬è´¨ï¼š                                                        â”‚
â”‚   â”œâ”€â”€ é…é¢æ˜¯åˆ†é…ç»™ task_groupï¼ˆcgroupï¼‰çš„                       â”‚
â”‚   â”œâ”€â”€ ç»„å†…æ‰€æœ‰è¿›ç¨‹å…±äº«è¿™ä¸ªé…é¢                                  â”‚
â”‚   â”œâ”€â”€ ä»»ä½•è¿›ç¨‹è¿è¡Œéƒ½ä¼šæ¶ˆè€—é…é¢                                  â”‚
â”‚   â””â”€â”€ é…é¢è€—å°½åˆ™æ•´ä¸ªç»„è¢«é™æµ                                    â”‚
â”‚                                                                 â”‚
â”‚   æ‰€ä»¥ï¼šé…é¢æœ¬è´¨ä¸Šå°±æ˜¯é™åˆ¶"è¿™äº›è¿›ç¨‹æ€»å…±èƒ½è¿è¡Œå¤šé•¿æ—¶é—´"          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### cfs_bandwidth çš„è§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cfs_bandwidth çš„è§’è‰²                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   cfs_bandwidth æ˜¯å†…æ ¸ä¸­å®ç°é…é¢é™åˆ¶çš„æ•°æ®ç»“æ„                  â”‚
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·ç©ºé—´                          å†…æ ¸ç©ºé—´                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                 â”‚
â”‚   echo "200000 100000"              task_group                  â”‚
â”‚     > cpu.max                           â”‚                       â”‚
â”‚         â”‚                               â†“                       â”‚
â”‚         â”‚                        cfs_bandwidth                  â”‚
â”‚         â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ quota = 200000ns    â”‚ é…ç½®å€¼â”‚
â”‚                                  â”‚ period = 100000ns   â”‚       â”‚
â”‚                                  â”‚ runtime = å‰©ä½™é…é¢  â”‚ åŠ¨æ€å€¼â”‚
â”‚                                  â”‚                     â”‚       â”‚
â”‚                                  â”‚ period_timer       â”‚ å®šæ—¶å™¨â”‚
â”‚                                  â”‚ slack_timer        â”‚       â”‚
â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                 â”‚
â”‚   cfs_bandwidth çš„èŒè´£ï¼š                                        â”‚
â”‚   â”œâ”€â”€ å­˜å‚¨é…é¢é…ç½®ï¼ˆquotaã€periodï¼‰                             â”‚
â”‚   â”œâ”€â”€ è·Ÿè¸ªå‰©ä½™å¯ç”¨æ—¶é—´ï¼ˆruntimeï¼‰                               â”‚
â”‚   â”œâ”€â”€ ç®¡ç†å®šæ—¶å™¨ï¼ˆperiod_timerã€slack_timerï¼‰                   â”‚
â”‚   â””â”€â”€ åè°ƒå„ CPU çš„é…é¢ç”³è¯·å’Œå½’è¿˜                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®Œæ•´çš„å…³ç³»é“¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»å®¹å™¨åˆ°é…é¢çš„å®Œæ•´å…³ç³»é“¾                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   å®¹å™¨é…ç½®                                                      â”‚
â”‚   docker run --cpus=2 nginx                                     â”‚
â”‚         â”‚                                                       â”‚
â”‚         â†“                                                       â”‚
â”‚   Cgroup æ–‡ä»¶                                                   â”‚
â”‚   /sys/fs/cgroup/docker/<id>/cpu.max = "200000 100000"          â”‚
â”‚         â”‚                                                       â”‚
â”‚         â†“                                                       â”‚
â”‚   task_groupï¼ˆæ¯ä¸ª cgroup ä¸€ä¸ªï¼‰                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   cfs_bandwidth â†â”€â”€â”€â”€â”€â”€ å…¨å±€é…é¢æ±                        â”‚  â”‚
â”‚   â”‚       â”œâ”€â”€ quota = 200msï¼ˆé…ç½®å€¼ï¼‰                        â”‚  â”‚
â”‚   â”‚       â”œâ”€â”€ period = 100msï¼ˆå‘¨æœŸï¼‰                         â”‚  â”‚
â”‚   â”‚       â”œâ”€â”€ runtime = å‰©ä½™é…é¢ï¼ˆåŠ¨æ€å˜åŒ–ï¼‰                 â”‚  â”‚
â”‚   â”‚       â”œâ”€â”€ period_timerï¼ˆå‘¨æœŸé‡ç½®ï¼‰                       â”‚  â”‚
â”‚   â”‚       â””â”€â”€ slack_timerï¼ˆå›æ”¶åˆ©ç”¨ï¼‰                        â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   se[0], cfs_rq[0] â†â”€â”€â”€â”€ CPU 0 ä¸Šçš„è°ƒåº¦ç»“æ„              â”‚  â”‚
â”‚   â”‚       â””â”€â”€ runtime_remainingï¼ˆæœ¬åœ°é…é¢ï¼‰                  â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   se[1], cfs_rq[1] â†â”€â”€â”€â”€ CPU 1 ä¸Šçš„è°ƒåº¦ç»“æ„              â”‚  â”‚
â”‚   â”‚       â””â”€â”€ runtime_remainingï¼ˆæœ¬åœ°é…é¢ï¼‰                  â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                       â”‚
â”‚         â†“                                                       â”‚
â”‚   è¿›ç¨‹è¿è¡Œæ—¶çš„é…é¢æµåŠ¨ï¼š                                        â”‚
â”‚   1. è¿›ç¨‹è¿è¡Œï¼Œæ¶ˆè€— cfs_rq.runtime_remaining                    â”‚
â”‚   2. æœ¬åœ°ä¸å¤Ÿæ—¶ï¼Œä» cfs_bandwidth.runtime ç”³è¯·                  â”‚
â”‚   3. å…¨å±€ä¹Ÿæ²¡äº†ï¼Œé™æµï¼Œç­‰ period_timer é‡ç½®                     â”‚
â”‚   4. è¿›ç¨‹ç¡çœ æ—¶ï¼Œå½’è¿˜å‰©ä½™é…é¢ï¼Œslack_timer åˆ†é…ç»™å…¶ä»– CPU       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®¹å™¨èµ„æºæ§åˆ¶çš„å®ç°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¹å™¨èµ„æºæ§åˆ¶çš„å®ç°                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   å®¹å™¨ = Namespaceï¼ˆéš”ç¦»è§†å›¾ï¼‰ + Cgroupï¼ˆé™åˆ¶èµ„æºï¼‰             â”‚
â”‚                                                                 â”‚
â”‚   å½“åˆ›å»ºä¸€ä¸ªå®¹å™¨æ—¶ï¼š                                            â”‚
â”‚                                                                 â”‚
â”‚   1. Namespace æä¾›éš”ç¦»                                         â”‚
â”‚      â”œâ”€â”€ PID Namespaceï¼šå®¹å™¨å†…è¿›ç¨‹ä»¥ä¸ºè‡ªå·±æ˜¯ PID 1              â”‚
â”‚      â”œâ”€â”€ Net Namespaceï¼šç‹¬ç«‹çš„ç½‘ç»œæ ˆ                            â”‚
â”‚      â””â”€â”€ Mount Namespaceï¼šç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿ                        â”‚
â”‚                                                                 â”‚
â”‚   2. Cgroup æä¾›èµ„æºé™åˆ¶                                        â”‚
â”‚      â”œâ”€â”€ åˆ›å»º cgroup ç›®å½• â†’ åˆ›å»º task_group                     â”‚
â”‚      â”œâ”€â”€ è®¾ç½® cpu.max â†’ å†™å…¥ cfs_bandwidth                      â”‚
â”‚      â”œâ”€â”€ æŠŠå®¹å™¨è¿›ç¨‹åŠ å…¥ cgroup                                  â”‚
â”‚      â””â”€â”€ è¿›ç¨‹è¿è¡Œæ—¶å—é…é¢é™åˆ¶                                   â”‚
â”‚                                                                 â”‚
â”‚   ç»“æœï¼š                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   å®¹å™¨å†…æ‰€æœ‰è¿›ç¨‹å…±äº«é…é¢                                 â”‚  â”‚
â”‚   â”‚       â†“                                                  â”‚  â”‚
â”‚   â”‚   è¶…è¿‡é…é¢å°±è¢«é™æµ                                       â”‚  â”‚
â”‚   â”‚       â†“                                                  â”‚  â”‚
â”‚   â”‚   å®ç°äº†"è¿™ä¸ªå®¹å™¨æœ€å¤šç”¨ N æ ¸ CPU"çš„æ•ˆæœ                  â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ï¼š                                              â”‚
â”‚   "å®¹å™¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªè¢« Namespace éš”ç¦»ã€è¢« Cgroup é™åˆ¶çš„è¿›ç¨‹"   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.15 Bandwidth vs Weightï¼šç¡¬é™åˆ¶ä¸è½¯é™åˆ¶

CPU Cgroup æä¾›ä¸¤ç§é™åˆ¶æ–¹å¼ï¼šBandwidthï¼ˆå¸¦å®½/é…é¢ï¼‰å’Œ Weightï¼ˆæƒé‡ï¼‰ï¼Œå®ƒä»¬æœ‰æœ¬è´¨åŒºåˆ«ã€‚

#### ä¸¤ç§é™åˆ¶æ–¹å¼å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Bandwidth vs Weight                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Bandwidthï¼ˆå¸¦å®½/é…é¢ï¼‰              Weightï¼ˆæƒé‡ï¼‰            â”‚
â”‚   cpu.max / cpu.cfs_quota_us          cpu.weight / cpu.shares   â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         â”‚    â”‚                         â”‚   â”‚
â”‚   â”‚   ç¡¬é™åˆ¶ï¼ˆHard Limitï¼‰  â”‚    â”‚   è½¯é™åˆ¶ï¼ˆSoft Limitï¼‰  â”‚   â”‚
â”‚   â”‚                         â”‚    â”‚                         â”‚   â”‚
â”‚   â”‚   "æœ€å¤šèƒ½ç”¨å¤šå°‘"        â”‚    â”‚   "ç«äº‰æ—¶æŒ‰æ¯”ä¾‹åˆ†"      â”‚   â”‚
â”‚   â”‚                         â”‚    â”‚                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚   Bandwidthï¼š                      Weightï¼š                     â”‚
â”‚   â”œâ”€â”€ ç»å¯¹å€¼é™åˆ¶                   â”œâ”€â”€ ç›¸å¯¹å€¼é™åˆ¶               â”‚
â”‚   â”œâ”€â”€ æ— è®º CPU æ˜¯å¦ç©ºé—²éƒ½ç”Ÿæ•ˆ     â”œâ”€â”€ åªåœ¨ CPU ç«äº‰æ—¶ç”Ÿæ•ˆ      â”‚
â”‚   â”œâ”€â”€ è¶…è¿‡å°±é™æµï¼ˆthrottleï¼‰      â”œâ”€â”€ ç©ºé—²æ—¶å¯ä»¥è¶…é¢ä½¿ç”¨       â”‚
â”‚   â””â”€â”€ é€šè¿‡ cfs_bandwidth å®ç°     â””â”€â”€ é€šè¿‡ vruntime å¢é•¿é€Ÿåº¦   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åœºæ™¯å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åœºæ™¯å¯¹æ¯”                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   åœºæ™¯ï¼š4 æ ¸ CPUï¼Œå®¹å™¨ A å’Œå®¹å™¨ B                               â”‚
â”‚                                                                 â”‚
â”‚   ä½¿ç”¨ Bandwidthï¼ˆé…é¢ï¼‰ï¼š                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  å®¹å™¨ Aï¼šcpu.max = "200000 100000"ï¼ˆ2 æ ¸ï¼‰              â”‚  â”‚
â”‚   â”‚  å®¹å™¨ Bï¼šcpu.max = "100000 100000"ï¼ˆ1 æ ¸ï¼‰              â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚  æƒ…å†µ 1ï¼šä¸¤ä¸ªå®¹å™¨éƒ½å¾ˆå¿™                                  â”‚  â”‚
â”‚   â”‚  â†’ A æœ€å¤šç”¨ 2 æ ¸ï¼ŒB æœ€å¤šç”¨ 1 æ ¸                          â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚  æƒ…å†µ 2ï¼šåªæœ‰ A åœ¨è¿è¡Œï¼ŒB ç©ºé—²                           â”‚  â”‚
â”‚   â”‚  â†’ A è¿˜æ˜¯æœ€å¤šç”¨ 2 æ ¸ï¼ï¼ˆç¡¬é™åˆ¶ï¼‰                         â”‚  â”‚
â”‚   â”‚    å‰©ä¸‹ 2 æ ¸ç©ºé—²æµªè´¹                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   ä½¿ç”¨ Weightï¼ˆæƒé‡ï¼‰ï¼š                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  å®¹å™¨ Aï¼šcpu.weight = 200                                â”‚  â”‚
â”‚   â”‚  å®¹å™¨ Bï¼šcpu.weight = 100                                â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚  æƒ…å†µ 1ï¼šä¸¤ä¸ªå®¹å™¨éƒ½å¾ˆå¿™                                  â”‚  â”‚
â”‚   â”‚  â†’ A åˆ†åˆ° 4Ã—(200/300) â‰ˆ 2.67 æ ¸                          â”‚  â”‚
â”‚   â”‚  â†’ B åˆ†åˆ° 4Ã—(100/300) â‰ˆ 1.33 æ ¸                          â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚  æƒ…å†µ 2ï¼šåªæœ‰ A åœ¨è¿è¡Œï¼ŒB ç©ºé—²                           â”‚  â”‚
â”‚   â”‚  â†’ A å¯ä»¥ç”¨æ»¡ 4 æ ¸ï¼ï¼ˆè½¯é™åˆ¶ï¼Œæ²¡ç«äº‰å°±ä¸é™ï¼‰             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å¯¹æ¯”æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¯¹æ¯”æ€»ç»“                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç‰¹æ€§          â”‚ Bandwidthï¼ˆé…é¢ï¼‰    â”‚ Weightï¼ˆæƒé‡ï¼‰         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   é™åˆ¶ç±»å‹      â”‚ ç¡¬é™åˆ¶               â”‚ è½¯é™åˆ¶                 â”‚
â”‚   ç”Ÿæ•ˆæ—¶æœº      â”‚ å§‹ç»ˆç”Ÿæ•ˆ             â”‚ åªåœ¨ç«äº‰æ—¶             â”‚
â”‚   ç©ºé—²æ—¶        â”‚ ä¸èƒ½è¶…é¢             â”‚ å¯ä»¥ç”¨æ»¡               â”‚
â”‚   å®ç°æœºåˆ¶      â”‚ cfs_bandwidth+å®šæ—¶å™¨ â”‚ vruntime å¢é•¿é€Ÿåº¦      â”‚
â”‚   é€‚ç”¨åœºæ™¯      â”‚ ä¸¥æ ¼é™åˆ¶ä¸Šé™         â”‚ ä¿è¯æœ€ä½ä»½é¢           â”‚
â”‚   Cgroup v1     â”‚ cpu.cfs_quota_us     â”‚ cpu.shares             â”‚
â”‚   Cgroup v2     â”‚ cpu.max              â”‚ cpu.weight             â”‚
â”‚                                                                 â”‚
â”‚   å®é™…ä½¿ç”¨ä¸­é€šå¸¸ç»“åˆä¸¤è€…ï¼š                                      â”‚
â”‚   â”œâ”€â”€ Weight ä¿è¯æœ€ä½ä»½é¢                                       â”‚
â”‚   â””â”€â”€ Bandwidth é™åˆ¶æœ€é«˜ä½¿ç”¨                                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.16 Kubernetes requests/limits ä¸ Cgroup çš„å¯¹åº”

Kubernetes çš„ `requests` å’Œ `limits` åº•å±‚å°±æ˜¯ç”¨ Weight å’Œ Bandwidth å®ç°çš„ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    K8s requests/limits ä¸ Cgroup                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Kubernetes é…ç½®                    Cgroup å®ç°                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                 â”‚
â”‚   resources:                                                    â”‚
â”‚     requests:                                                   â”‚
â”‚       cpu: "500m"          â”€â”€â”€â†’    cpu.weight / cpu.shares     â”‚
â”‚                                    ï¼ˆè½¯é™åˆ¶ï¼Œä¿è¯æœ€ä½ä»½é¢ï¼‰     â”‚
â”‚                                                                 â”‚
â”‚     limits:                                                     â”‚
â”‚       cpu: "2"             â”€â”€â”€â†’    cpu.max / cpu.cfs_quota_us  â”‚
â”‚                                    ï¼ˆç¡¬é™åˆ¶ï¼Œä¸èƒ½è¶…è¿‡ï¼‰         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### requests ä¸ limits çš„å«ä¹‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    requests ä¸ limits çš„å«ä¹‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   requests: 500m                                                â”‚
â”‚   â”œâ”€â”€ å«ä¹‰ï¼š"æˆ‘è‡³å°‘éœ€è¦ 0.5 æ ¸"                                 â”‚
â”‚   â”œâ”€â”€ å®ç°ï¼šç”¨ cpu.weight å®ç°                                  â”‚
â”‚   â”œâ”€â”€ æ•ˆæœï¼šç«äº‰æ—¶ä¿è¯èƒ½åˆ†åˆ°è¿™ä¹ˆå¤š                              â”‚
â”‚   â””â”€â”€ ç”¨é€”ï¼šK8s è°ƒåº¦ä¾æ®ï¼ˆèŠ‚ç‚¹æ˜¯å¦æœ‰è¶³å¤Ÿèµ„æºï¼‰                  â”‚
â”‚                                                                 â”‚
â”‚   limits: 2                                                     â”‚
â”‚   â”œâ”€â”€ å«ä¹‰ï¼š"æˆ‘æœ€å¤šç”¨ 2 æ ¸"                                     â”‚
â”‚   â”œâ”€â”€ å®ç°ï¼šç”¨ cpu.max (bandwidth) å®ç°                         â”‚
â”‚   â”œâ”€â”€ æ•ˆæœï¼šè¶…è¿‡å°±è¢«é™æµ                                        â”‚
â”‚   â””â”€â”€ ç”¨é€”ï¼šé˜²æ­¢å•ä¸ª Pod è€—å°½èŠ‚ç‚¹èµ„æº                           â”‚
â”‚                                                                 â”‚
â”‚   å®é™…æ•ˆæœï¼š                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚   ç©ºé—²æ—¶ï¼šå¯ä»¥ç”¨åˆ° limitsï¼ˆ2 æ ¸ï¼‰                        â”‚  â”‚
â”‚   â”‚   ç«äº‰æ—¶ï¼šè‡³å°‘ä¿è¯ requestsï¼ˆ0.5 æ ¸ï¼‰                    â”‚  â”‚
â”‚   â”‚   ä»»ä½•æ—¶å€™ï¼šä¸èƒ½è¶…è¿‡ limitsï¼ˆ2 æ ¸ï¼‰                      â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸ºä»€ä¹ˆå»ºè®®åŒæ—¶è®¾ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸ºä»€ä¹ˆå»ºè®®åŒæ—¶è®¾ç½® requests å’Œ limits         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   åªè®¾ç½® requestsï¼š                                             â”‚
â”‚   â”œâ”€â”€ ä¿è¯æœ€ä½ä»½é¢                                              â”‚
â”‚   â””â”€â”€ ä½†æ²¡æœ‰ä¸Šé™ï¼Œå¯èƒ½è€—å°½èŠ‚ç‚¹èµ„æº                              â”‚
â”‚                                                                 â”‚
â”‚   åªè®¾ç½® limitsï¼š                                               â”‚
â”‚   â”œâ”€â”€ æœ‰ä¸Šé™ä¿æŠ¤                                                â”‚
â”‚   â””â”€â”€ ä½†ç«äº‰æ—¶æ²¡æœ‰ä¿è¯ï¼Œå¯èƒ½è¢«é¥¿æ­»                              â”‚
â”‚                                                                 â”‚
â”‚   åŒæ—¶è®¾ç½®ï¼š                                                    â”‚
â”‚   â”œâ”€â”€ requestsï¼šè°ƒåº¦ä¾æ® + æœ€ä½ä¿è¯ï¼ˆweightï¼‰                   â”‚
â”‚   â””â”€â”€ limitsï¼šèµ„æºä¸Šé™ï¼ˆbandwidthï¼‰                             â”‚
â”‚                                                                 â”‚
â”‚   æœ€ä½³å®è·µï¼š                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  resources:                                              â”‚  â”‚
â”‚   â”‚    requests:                                             â”‚  â”‚
â”‚   â”‚      cpu: "500m"      # ä¿è¯æœ€ä½ 0.5 æ ¸                  â”‚  â”‚
â”‚   â”‚      memory: "512Mi"                                     â”‚  â”‚
â”‚   â”‚    limits:                                               â”‚  â”‚
â”‚   â”‚      cpu: "2"         # æœ€å¤šç”¨ 2 æ ¸                      â”‚  â”‚
â”‚   â”‚      memory: "1Gi"                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

*æŒç»­æ›´æ–°ä¸­...*
