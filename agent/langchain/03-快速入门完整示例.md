# 03 - 快速入门完整示例

本节基于 LangChain 官方快速入门教程，实现一个完整的天气查询 Agent。

## 安装依赖

```bash
pip install langchain langchain-openai langgraph python-dotenv
```

## 完整代码结构

```
1. 导入模块
2. 定义系统提示词
3. 创建工具（@tool 装饰器）
4. 定义上下文和响应格式
5. 配置模型
6. 创建 Agent
7. 运行对话
```

## 核心概念详解

### 1. @tool 装饰器

把普通函数变成 Agent 可调用的工具：

```python
from langchain.tools import tool

@tool
def get_weather_for_location(city: str) -> str:
    """Get weather for a given city."""
    return f"It's always sunny in {city}!"
```

装饰器做了三件事：
- 函数名 → 工具名
- docstring → 工具描述（AI 靠这个判断何时调用）
- 类型注解 → 输入 schema

### 2. ToolRuntime 与 Context

让工具能访问运行时上下文（比如当前用户是谁）：

```python
from dataclasses import dataclass
from langchain.tools import ToolRuntime

@dataclass
class Context:
    """自定义上下文"""
    user_id: str

@tool
def get_user_location(runtime: ToolRuntime[Context]) -> str:
    """获取用户位置"""
    user_id = runtime.context.user_id
    return "Florida" if user_id == "1" else "SF"
```

`runtime.context` 是系统注入的，不是 AI 传的参数。

**数据流向：**
```
invoke(context=Context(user_id="1"))
           ↓
    LangChain 包装进 runtime
           ↓
    工具调用时 runtime.context.user_id = "1"
           ↓
    工具返回结果给 Agent
```

**大小写区别：**
- `Context`（大写）= 类名/类型定义
- `context`（小写）= 参数名/变量名

```python
@dataclass
class Context:      # 大写 = 定义类
    user_id: str

agent.invoke(
    context=Context(user_id="1")  # 小写 = 参数名，大写 = 创建实例
)
```

### 3. 结构化输出（ResponseFormat）

让 Agent 返回固定格式的数据，类似 Java 的 DTO：

```python
from dataclasses import dataclass
from langchain.agents.structured_output import ToolStrategy

@dataclass
class ResponseFormat:
    """响应格式"""
    punny_response: str                    # 必填：双关语回答
    weather_conditions: str | None = None  # 可选：天气状况

agent = create_agent(
    ...
    response_format=ToolStrategy(ResponseFormat),
)
```

- `ResponseFormat` 定义返回数据的结构（有哪些字段）
- `ToolStrategy` 是生成策略，让 AI 把输出当作"工具调用"来处理
- 没有它 AI 可能返回任意文本，有了它必须返回固定格式

返回值示例：
```python
ResponseFormat(
    punny_response="Florida is having a 'sun-derful' day!",
    weather_conditions="It's always sunny in Florida!"
)
```

### 4. 记忆功能（Checkpointer）

让 Agent 记住对话历史：

```python
from langgraph.checkpoint.memory import InMemorySaver

checkpointer = InMemorySaver()

agent = create_agent(
    ...
    checkpointer=checkpointer,
)

# 使用 thread_id 标识对话
config = {"configurable": {"thread_id": "1"}}
response = agent.invoke(..., config=config)
```

同一个 `thread_id` 的对话会共享记忆：

```python
# 第一次对话
agent.invoke({"messages": [{"content": "我叫小明"}]}, config=config)

# 第二次对话，AI 还记得
agent.invoke({"messages": [{"content": "我叫什么？"}]}, config=config)
# AI 回答：你叫小明
```

**thread_id 的作用：**
```python
# 用户 A 的对话
agent.invoke(..., config={"configurable": {"thread_id": "user_a"}})

# 用户 B 的对话（记忆隔离）
agent.invoke(..., config={"configurable": {"thread_id": "user_b"}})
```

`InMemorySaver` 存在内存里，程序重启就没了。生产环境可以换成数据库存储。

### 5. 模型配置

使用阿里云千问模型（OpenAI 兼容接口）：

```python
from langchain.chat_models import init_chat_model

model = init_chat_model(
    "qwen-plus",
    model_provider="openai",
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
    api_key=os.getenv("DASHSCOPE_API_KEY"),
    temperature=0.5
)
```

常用模型：
| 模型 | 特点 |
|------|------|
| qwen-plus | 性价比高，支持非流式 |
| qwen-max | 能力最强 |
| qwen-turbo | 速度最快 |
| qwq-32b | 推理模型，只支持流式 |

## 调用 Agent

```python
config = {"configurable": {"thread_id": "1"}}

response = agent.invoke(
    {"messages": [{"role": "user", "content": "what is the weather outside?"}]},
    config=config,
    context=Context(user_id="1")
)
```

三个参数：
| 参数 | 作用 |
|------|------|
| `messages` | 用户说的话 |
| `config` | 指定哪个对话会话（记忆隔离） |
| `context` | 传给工具的上下文（比如当前用户是谁） |

## 流式 vs 非流式

| 类型 | 方法 | 特点 |
|------|------|------|
| 非流式 | `agent.invoke()` | 等待完整结果返回 |
| 流式 | `agent.stream()` | 边生成边返回，逐字显示 |

```python
# 非流式
response = agent.invoke(...)

# 流式
for chunk in agent.stream(...):
    print(chunk, end="")
```

## 完整示例代码

见 `examples/ex01_base_agent.py`

## 执行流程

```
用户: "what is the weather outside?"
    ↓
Agent 分析: 用户问天气，但没说地点，需要先获取位置
    ↓
调用 get_user_location(context.user_id="1") → "Florida"
    ↓
调用 get_weather_for_location("Florida") → "It's always sunny in Florida!"
    ↓
组织回答: ResponseFormat(punny_response="...", weather_conditions="...")
```

## 关键点总结

1. **@tool** - 把函数变成 AI 可调用的工具
2. **ToolRuntime** - 让工具访问运行时上下文
3. **ResponseFormat** - 结构化输出，固定返回格式
4. **InMemorySaver** - 对话记忆，支持多轮对话
5. **thread_id** - 标识不同对话会话
